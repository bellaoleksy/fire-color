---
title: "fire-color: preview Data"
subtitle: "identifying post-fire color changes in lakes of the western U.S."
author: "Bella Oleksy et al. "
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    latex_engine: pdflatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir='..')
knitr::opts_chunk$set(fig.width=6,fig.height=8,
                      echo=FALSE, 
               warning=FALSE, message=FALSE) 

```



```{r some package version control stuff, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##Hi! If you have never used renv read their little vignette here. 
##https://rstudio.github.io/renv/articles/renv.html

##If you've ever had script not work after updating R/various libraries, using
##renv() is a nice way to avoid a lot of future headaches. -IAO

if (!require('renv')) install.packages('renv');library('renv')

#Create a lockfile for packages
# renv::init()
```


```{r Load necessary packages, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library('here')

##enable easy file referencing in project-oriented workflows.
##https://rstats.wtf/project-oriented-workflow.html
## ^ ^ a little more on that

# source("fire-color/scripts/00_libraries.R")
source("scripts/00_libraries.R")



```


```{r Load LAGOS IDs dataframe, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# source("fire-color/scripts/01.0_pullLakeIDsLAGOS.R")
# source("fire-color/scripts/01.1_pullLakeCat.R")
source("scripts/01.0_pullLakeIDsLAGOS.R")
source("scripts/01.1_pullLakeCat.R")
#Currently only pulling out MTBS, FirePerimeters, and ForestLoss, but all the other data is in that R file and commented out for speed. 

```


```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Describes proportion of catchment / watershed within burn perimeters
#But I think I'm missing the burn severity numbers 
MTBS_long <- lakeCat %>%
  dplyr::select(nhdplusv2_comid,lake_nhdid,nhdplusv2_reachcode,lake_namegnis, lake_lon_decdeg, lake_lat_decdeg, contains("MTBS"))%>%
  pivot_longer(-(1:6), names_pattern = "(\\d+)([A-Za-z]+)", names_to = c("year","scale"))
    # "([A-Za-z]+)" matches only letters, so will pull out just "Ws" or "Cat". "(\\d+)" matches digits and will pull out the year.
  
names(MTBS_long)
```

# MTBS data visualization

The data below are summaries of the Monitoring Trends in Burn Severity (MTBS) data, extracted from [EPA's LakeCat dataset](https://www.epa.gov/national-aquatic-resource-surveys/lakecat-dataset-0). Before diving into this project, we want to get a sense for just how many lakes in the western U.S. are affected by fires every year. This particular dataset spans the years 1984-2018. 

## Histograms of % area burned by Ws and Cat scales

```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', fig.height=8}
MTBS_long %>%
  filter(value>1)%>%
  filter(scale=="Ws") %>%
  mutate(year=as.numeric(year))%>%
  ggplot(aes(value, group=year)) +
  geom_histogram(aes(fill=year)) +  # scale histogram y
  # geom_density(aes(color=year), alpha=0.4) +
  facet_wrap(~year, scales="free") +
  scale_fill_continuous_sequential(palette="ag_Sunset")+
  scale_color_continuous_sequential(palette="ag_Sunset")+
  ggtitle("MTBS % area burned - Ws scale")+
  ggpubr::theme_pubr(base_size=8)



```
\newpage
```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', fig.height=8}
MTBS_long %>%
  filter(value>1)%>%
  filter(scale=="Cat") %>%
  mutate(year=as.numeric(year))%>%
  ggplot(aes(value, group=year)) +
  geom_histogram(aes(fill=year)) +  # scale histogram y
  # geom_density(aes(color=year), alpha=0.4) +
  facet_wrap(~year, scales="free") +
  scale_fill_continuous_sequential(palette="ag_Sunset")+
  scale_color_continuous_sequential(palette="ag_Sunset")+
  ggtitle("MTBS % area burned - Cat scale (local)") +
  ggpubr::theme_pubr(base_size=8)
```

In every year there are always a number of lakes that burn severly (>90% of the total area of every local catchment. If you look at the full watershed (Ws) scale there are a lot more lakes on the low end (<20%).

```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', fig.height=8}

#Number of lakes that experienced forest loss due to fire within local catchment
MTBS_summary<- left_join(MTBS_long%>%
  filter(value>1)%>%
  filter(scale=="Cat") %>%
  group_by(year) %>%
  summarize(n_lakes_Cat=length(unique(nhdplusv2_comid))) ,

#Number of lakes that experienced forest loss due to fire 2000-2010 within larger watershed
MTBS_long%>%
  filter(value>1)%>%
  filter(scale=="Ws") %>%
  group_by(year) %>%
  summarize(n_lakes_Ws=length(unique(nhdplusv2_comid))) ,

by="year")


knitr::kable(MTBS_summary, "simple", caption="Table summarizing the number of lakes with any percentage burn (>1%) at the local catchment (Cat) and full watershed (Ws) scale, by year")
```

Looks promising, we have hundreds of lakes lakes that were close to forests fires in every year and the numbers fluctuate quite a bit year-to-year.


## Total annual number of lakes in burned watersheds/local catchments

```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', fig.height=4}
MTBS_summary %>%
  pivot_longer(-1)%>%
  ggplot(aes(x=as.numeric(as.character(year)),y=value, fill=name, color=name, group=name))+
  geom_line()+
  geom_point(shape=21, size=2.5)+
  scale_color_manual(values=c("#90a955","#31572c"),
                    labels=c("Local catchment","Full watershed"),
                    name="Legend")+
  scale_fill_manual(values=c("#90a955","#31572c"),
                    labels=c("Local catchment","Full watershed"),
                    name="Legend")+
  scale_x_continuous(limits = c(1984, 2018),
                     breaks = seq(1984, 2018, by = 2))+
  labs(x="Year",
       y="n lakes",
       title="Number of lakes in burned watersheds/local catchments")+
  ggpubr::theme_pubr(base_size=8)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=8))
```

Looks like there is a step-change increase in the number of lakes in burned watersheds in the early 2000s, though no breakpoint detected using segmented regerssion. 

```{r, include=TRUE, error=FALSE}
# -------------------
# analyse breakpoints
# -------------------
# http://cran.r-project.org/doc/Rnews/Rnews_2008-1.pdf
if (!require('segmented')) install.packages('segmented');library('segmented')

MTBS_summary2<- MTBS_summary %>%
  mutate(year=as.numeric(as.character(year)))

# create a linear model
my.lm <- lm(n_lakes_Cat ~ year, data = MTBS_summary2)
summary(my.lm)

# # have to provide estimates for breakpoints.
# # after looking a the data, 
# my.seg <- segmented(my.lm, 
#                     seg.Z = ~ year, 
#                     psi = NA)
# 
# # When not providing estimates for the breakpoints "psi = NA" can be used.
# # The number of breakpoints that will show up is not defined
# #my.seg <- segmented(my.lm, 
# #                    seg.Z = ~ DistanceMeters, 
# #                    psi = NA)
# 
# # display the summary
# summary(my.seg)

```
\newpage
## Total number of burned lakes by burn severity class

I was also curious to see if there is an increasing trend in the number of lakes burned within each size class at the local catchment and full watershed scales. Below I plotted the trends and printed the results from simple linear models (though another method like sen slopes would probably be more appropriate here).

```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', fig.height=4}
# New facet label names for supp variable
scale.labs <- c("Local catchment", "Full watershed") 
names(scale.labs)<- c("Cat", "Ws")

BurnClassCount<-MTBS_long %>%
  filter(value>1)%>%
  group_by(scale)%>%
  mutate(burnSeverityClass=
           ifelse(value >1 & value <=20, "< 20%", 
                  ifelse(value >20 & value <=40, "20-40%", 
                         ifelse(value >40 & value <=60, "40-60%", 
                                ifelse(value >60 & value <=80, "60-80%",
                                       ifelse(value >80 , "> 80%", "error")))))) %>%
  mutate(burnSeverityClass = factor(burnSeverityClass,
                             levels = c("< 20%", "20-40%", "40-60%",
                                        "60-80%", "> 80%"))) %>%#Reorder factors for plotting
  group_by(year, scale, burnSeverityClass) %>%
  summarize(n_lakes=length(unique(nhdplusv2_comid))) 

BurnClassCount %>%
  ggplot(aes(x=as.numeric(as.character(year)),y=n_lakes, fill=burnSeverityClass, color=burnSeverityClass, group=burnSeverityClass))+
  geom_line()+
  geom_point(shape=21, size=2.5, color="black")+
  scale_fill_manual(values=c("#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51"),
                    name="Burn severity (% area)")+
  scale_color_manual(values=c("#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51"),
                    name="Burn severity (% area)")+
  scale_x_continuous(limits = c(1984, 2018),
                     breaks = seq(1984, 2018, by = 2))+
  facet_grid(burnSeverityClass~scale,
             scales = "free_y",
             labeller = labeller(scale = scale.labs))+
  labs(x="Year",
       y="n lakes",
       title="Number of lakes in each burn severity class")+
  ggpubr::theme_pubr(base_size=8)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=8),
        strip.text = element_text(face="bold"))
```

```{r, tidy=TRUE, error=FALSE, message=FALSE}
#How many of these trends are increasing?
BurnClassLMs<-BurnClassCount%>%
  # filter(scale=="Ws") %>% 
  group_by(scale,burnSeverityClass) %>%
  do(tidy(lm(year ~ n_lakes, .))) %>%
  arrange(burnSeverityClass, scale) 

knitr::kable(BurnClassLMs, "simple", caption="Table summarizing the linear model results")
```

The number of fires in every size class has been increasing through time with the exception of > 80% burn at the local catchment and full watershed scales. The strongest trend is at the local catchment scale with burned severity of 60-80% and 40-60%, though the total number of lakes affected is still relatively low.

## Burn severity maps
```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
rivers50 <- ne_download(scale = "large", type = 'rivers_lake_centerlines', category = 'physical', returnclass = "sf")
# sp::plot(rivers50)
us <- ne_countries(scale = "medium", country="united states of america",returnclass = "sf")

states<-(map_data("state", boundary = FALSE, interior = TRUE))
```

I'd like to use these maps to understand a few spatiotemporal patterns

- Can we see how the location of fires has changed over time?
- Where have the most severe burns taken places?
- Which areas have the most small fires? large fires? medium fires?

### Maps - changes through time

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8, fig.height=7}

ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    coord_sf(xlim = c(-125, -103), ylim = c(32, 49), expand=TRUE)+
  geom_jitter(data=MTBS_long %>%
                    filter(value>1)%>%
                    filter(scale=="Cat") %>%
                    mutate(year=as.numeric(year)),
             aes(lake_lon_decdeg, lake_lat_decdeg, fill=year),
             shape=21, size=1.5)+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.title=element_blank())+
  scale_fill_continuous_sequential(palette="ag_Sunset")+
  scale_color_continuous_sequential(palette="ag_Sunset")+
  labs(title="Every fire in the western U.S. 1984-2018",
       subtitle="")
```

In the graph above, each point represents a lake where >1% of the local catchment burned. Right away you can see some clustering. For example, the 1988 Yellowstone fire complex shows up pretty vividly in the northwestern corner of Wyoming. There appears to be a lot more redish/purple hues in California where we know wildfires have been increasing. 

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8, fig.height=7}

ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
    # annotation_scale(location = "bl", width_hint = 0.5) +
    coord_sf(xlim = c(-125, -114), ylim = c(32, 42), expand=TRUE)+
  geom_jitter(data=MTBS_long %>%
                    filter(value>1)%>%
                    filter(scale=="Cat") %>%
                    mutate(year=as.numeric(year)),
             aes(lake_lon_decdeg, lake_lat_decdeg, fill=year),
             shape=21, size=2.5, alpha=0.8)+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.title=element_blank())+
  scale_fill_continuous_sequential(palette="ag_Sunset")+
  scale_color_continuous_sequential(palette="ag_Sunset")+
  labs(title="Every fire in California 1984-2018")
```

If you zoom in on just california you can see that there is a large group of lakes in northern California that bruned in the late 2010s. There is another group of lakes in southern California that burned about 10 years earlier. Will be interesting to see the burn severity on those sites, and look at their recovery trajectory. 

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8, fig.height=7}

ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
    # annotation_scale(location = "bl", width_hint = 0.5) +
    coord_sf(xlim = c(-117, -110), ylim = c(42, 49), expand=TRUE)+
  geom_jitter(data=MTBS_long %>%
                    filter(value>1)%>%
                    filter(scale=="Cat") %>%
                    mutate(year=as.numeric(year)),
             aes(lake_lon_decdeg, lake_lat_decdeg, fill=year),
             shape=21, size=2.5, alpha=0.8)+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.title=element_blank())+
  scale_fill_continuous_sequential(palette="ag_Sunset")+
  scale_color_continuous_sequential(palette="ag_Sunset")+
  labs(title="Every fire in Idaho 1984-2018")
```

Looking at Idaho, it appears that there are more fires in recent years though you do see a handfull of sites from the 90s scattered about. 

### Maps -- spatial structure of burn severity

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8, fig.height=7}
ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    coord_sf(xlim = c(-125, -103), ylim = c(32, 49), expand=TRUE)+
  geom_jitter(data=MTBS_long %>%
                      filter(value>1)%>%
                      group_by(scale)%>%
                      mutate(burnSeverityClass=
                              ifelse(value >1 & value <=20, "< 20%", 
                                     ifelse(value >20 & value <=40, "20-40%", 
                                            ifelse(value >40 & value <=60, "40-60%", 
                                                   ifelse(value >60 & value <=80, "60-80%",
                                                          ifelse(value >80 , "> 80%", "error")))))) %>%
                      mutate(burnSeverityClass = factor(burnSeverityClass,
                                                levels = c("< 20%", "20-40%", "40-60%",
                                                           "60-80%", "> 80%"))) %>% #Reorder factors for plotting
                      filter(scale=="Cat"),
             aes(lake_lon_decdeg, lake_lat_decdeg, fill=burnSeverityClass),
             shape=21, size=1.5)+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.title=element_blank())+
    scale_fill_manual(values=c("#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51"),
                    name="Burn severity (% area)")+
  labs(title="Lakes that burned in the western US",
       subtitle="")
```
\newpage
What if we only look at the most severe burns? Where are those sites?

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8, fig.height=7}
ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    coord_sf(xlim = c(-125, -103), ylim = c(32, 49), expand=TRUE)+
  geom_jitter(data=MTBS_long %>%
                      filter(value>1)%>%
                      group_by(scale)%>%
                      mutate(burnSeverityClass=
                              ifelse(value >1 & value <=20, "< 20%", 
                                     ifelse(value >20 & value <=40, "20-40%", 
                                            ifelse(value >40 & value <=60, "40-60%", 
                                                   ifelse(value >60 & value <=80, "60-80%",
                                                          ifelse(value >80 , "> 80%", "error")))))) %>%
                      filter(burnSeverityClass=="> 80%") %>%
                      filter(scale=="Cat"),
             aes(lake_lon_decdeg, lake_lat_decdeg, fill=burnSeverityClass),
             shape=21, size=1.5)+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.title=element_blank())+
    scale_fill_manual(values=c("#e76f51"),
                    name="Burn severity (% area)")
```

Wow! Loads of lakes all over. Way more than I anticipated in Idaho. What if we look at all the lakes where >80% of the watershed burned... WHEN did those burns occur?
\newpage
```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=8, fig.height=7}

ggplot()+
    geom_sf(data = us,color = "black")+
      geom_polygon(data=states, aes(x=long, y=lat, group=group),
               fill=NA, color="black",
               linetype="dashed")+
    geom_sf(data=rivers50, color="lightblue")+
    annotation_scale(location = "bl", width_hint = 0.5) +
    coord_sf(xlim = c(-125, -103), ylim = c(32, 49), expand=TRUE)+
  geom_jitter(data=MTBS_long %>%
                      filter(value>1)%>%
                      group_by(scale)%>%
                      mutate(burnSeverityClass=
                              ifelse(value >1 & value <=20, "< 20%", 
                                     ifelse(value >20 & value <=40, "20-40%", 
                                            ifelse(value >40 & value <=60, "40-60%", 
                                                   ifelse(value >60 & value <=80, "60-80%",
                                                          ifelse(value >80 , "> 80%", "error")))))) %>%
                      filter(burnSeverityClass=="> 80%") %>%
                      filter(scale=="Cat")%>%
                    mutate(year=as.numeric(year)),
             aes(lake_lon_decdeg, lake_lat_decdeg, fill=year),
             shape=21, size=1.5)+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.title=element_blank())+
  scale_fill_continuous_sequential(palette="ag_Sunset")+
  scale_color_continuous_sequential(palette="ag_Sunset")+
  labs(title="Timing of severe burns",
       subtitle="")

```

\newpage
# Water color proof of concept

How many lakes do we have where the local catchment burned >90%? We think that is where we are most likely to see a color response if there is one. 

```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', fig.height=6}

#Number of lakes that experienced forest loss due to fire within local catchment
MTBS_summary_severe<- left_join(MTBS_long%>%
  filter(value>80)%>%
  filter(scale=="Cat") %>%
  group_by(year) %>%
  summarize(`n lakes > 80% burned`=length(unique(nhdplusv2_comid))),
  MTBS_long%>%
  filter(value>90)%>%
  filter(scale=="Cat") %>%
  group_by(year) %>%
  summarize(`n lakes > 90% burned`=length(unique(nhdplusv2_comid))))


knitr::kable(MTBS_summary_severe, "simple", caption="Table summarizing the number of lakes with severe burns at the local catchment (Cat) scale, by year")
```

We have a total of 1070 lakes to check out if we used the >80% burn threshold cut off. We have 964 if we use the >90% cut-off. 

```{r, echo=FALSE, message=FALSE, warning=FALSE,out.width = '100%', out.height='100%'}
MTBS_summary_severe %>%
  pivot_longer(-1) %>%
  ggplot(aes(x=as.numeric(as.character(year)),y=value, fill=name,group=name))+
    geom_line()+
  geom_point(shape=21, size=2.5)+
  scale_fill_manual(values=c("#ee9b00","#ae2012"),
                    name="",
                    labels=c(">80%",">90%"))+
  scale_x_continuous(limits = c(1984, 2018),
                     breaks = seq(1984, 2018, by = 2))+
  labs(x="Year",
       y="n lakes",
       title="Number of lakes where >80-90% of the local catchment burned")+
  ggpubr::theme_pubr(base_size=12)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=8))
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#Read in NHD IDs that Matt sent
HydroLakes_DP_comids <- read.csv("~/Dropbox/dropbox Research/fire-color/data/hydroLakes/full_lakes_nhd.csv") %>%
    # rename(COMID=comid) 
  rename(nhdplusv2_comid=comid) %>%
  mutate(nhdplusv2_comid=as.character(as.numeric(nhdplusv2_comid))) 

HydroLakes_DP_comids<-HydroLakes_DP_comids %>%
  separate(id, c("name","Hylak_id"),sep="nhdwaterbody.")%>%
  dplyr::select(Hylak_id, nhdplusv2_comid, gnis_id, gnis_name)


HydroLakes_DP_comids_trim<- HydroLakes_DP_comids %>%
  distinct(nhdplusv2_comid, .keep_all=TRUE) 
str(HydroLakes_DP_comids_trim)


#Read in HydroLakes color stuff
srCor<-read_feather('~/Dropbox/dropbox Research/Western-Color-Fire/srCorrected_us_hydrolakes_dp_20200628.feather') %>%
  mutate(Hylak_id=as.character(as.numeric(Hylak_id))) 
str(srCor)

#Join HydroLakes_DP_comids_trim to srCor so we have COMID 
srCor_comid<-left_join(srCor, HydroLakes_DP_comids, by="Hylak_id")
srCor_comid_NAfree<-srCor_comid %>%
  drop_na(nhdplusv2_comid) %>%
  mutate(year=as.character(as.numeric(year)))

#Extract the COMIDs of all the lakes that burned
nhdplusv2_comidNAMES<- MTBS_long %>%
  filter(value>90)%>%
  filter(scale=="Cat") %>%
  dplyr::select(nhdplusv2_comid,value,year) %>%
  group_by(nhdplusv2_comid) %>%
  distinct(year, .keep_all=TRUE) %>%
  dplyr::select(-year)%>%
  pivot_wider(names_from=nhdplusv2_comid, values_from=value, values_fn=mean)%>%
  names()

#Create srCor dataframe including ONLY the lakes that severely burned...
srCor_comid_NAfree_severeBurn <- srCor_comid_NAfree %>%
  filter(nhdplusv2_comid %in% nhdplusv2_comidNAMES)
## ^^ doesn't work...


srCor_comid_NAfree_severeBurn<-left_join(MTBS_severe,srCor_comid_NAfree,by=c("year","nhdplusv2_comid")) 


# lake_nhdidNAMES<- MTBS_long %>%
#   filter(value>90)%>%
#   filter(scale=="Cat") %>%
#   dplyr::select(lake_nhdid,value,year) %>%
#   group_by(lake_nhdid) %>%
#   distinct(year, .keep_all=TRUE) %>%
#   dplyr::select(-year)%>%
#   pivot_wider(names_from=lake_nhdid, values_from=value, values_fn=mean)

HydroLakes_DP_comids_trim<- HydroLakes_DP_comids %>%
  filter(nhdplusv2_comid %in% nhdplusv2_comidNAMES)

MTBS_trim <- MTBS %>%
  dplyr::select(nhdplusv2_comid, contains("MTBS"))%>%
  pivot_longer(-(1), names_pattern = "(\\d+)([A-Za-z]+)", names_to = c("year","scale")) %>%
  filter(scale=="Cat") %>%
  filter(value>90)


testjoin<-full_join(MTBS_trim,HydroLakes_DP_comids,by="nhdplusv2_comid") %>%
  drop_na(Hylak_id)


MTBS_severe<-MTBS_long %>%
  filter(value>90)%>%
  filter(scale=="Cat") %>%
  dplyr::select(nhdplusv2_comid,value,year,lake_lon_decdeg,lake_lat_decdeg)

testjoin2<-left_join(MTBS_severe,HydroLakes_DP_comids_trim,by="nhdplusv2_comid") %>%
  drop_na(Hylak_id)




```
