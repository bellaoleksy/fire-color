---
title: "Rbeast Analysis - Proof of concept"
subtitle: "identifying post-fire color changes in lakes of the western U.S."
author: "Bella Oleksy et al. "
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

In this Rmarkdown doc I'll summarize the results of the Bayesian time series decomposition for changepoint, trend, and periodicity or seasonality method (BEAST via `Rbeast`) model which was created by <a href="https://doi.org/10.1016/j.rse.2019.04.034">Kaiguang Zhao et al. in 2019</a> and published in Remote Sensing. What I'm hoping to show here that is we can use this model to test for abrupt changes in dWL following wildfires. 

**What is BEAST? From the authors:**

"BEAST is a Bayesian regression method to isolate periodic and trend signals from a time series and to pinpoint abrupt shifts in the two isolated signals. It is intended primarily for trend analysis and detection of changepoints and phenological shifts, targeted at questions like:

- Are there any increasing or decreasing trends, any changepoints, or any phenological shifts?
- What is the rate of change at a given time?
- Is the detected greening trend real?
- What is the probability of observing 3 changepoints between 2001 and 2015, or both a seasonal and a trend changepoint in August 2009?"  

**Strengths of this method incldue:**

- TONS of information in the model output
- Nice graphics for visualizing the model output
- Estimates of uncertainty around here trend and seasonal changepoint
- Appropriate for timeseries analysis because of the way you code in seasonality and temporal autocorrelation

**Weakness of this method include:**

- You get *slightly* different results every time you run the model. But not really a big deal, and if you `set.seed()` the variability is minimal
- BEAST detects temporal dynamics but can't attribute drivers. Again, I think this fine since we are testing whether is *is* a response to a driver that we already know of (fire). 

**Other ways of quantifying fire responses**

I'll also experiment with other ways of looking at lake color responses to fires. For example, even if there is not an "abrupt" shift as indicated by the BEAST model, do we see general greening or blueing?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, error = TRUE,warning = F, comment = F, message = F, fig.width=8,fig.height=11)


knitr::opts_knit$set(root.dir='..')

```

```{r some package version control stuff, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##Hi! If you have never used renv read their little vignette here. 
##https://rstudio.github.io/renv/articles/renv.html

##If you've ever had script not work after updating R/various libraries, using
##renv() is a nice way to avoid a lot of future headaches. -IAO

# if (!require('renv')) install.packages('renv');library('renv')

#Create a lockfile for packages
# renv::init()
```

```{r Load necessary packages, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
if (!require('here')) install.packages('here');library('here') 


##enable easy file referencing in project-oriented workflows.
##https://rstats.wtf/project-oriented-workflow.html
## ^ ^ a little more on that

# source("fire-color/scripts/00_libraries.R")
# source("fire-color/scripts/00_helperFuns.R")

source("scripts/00_libraries.R")
source("scripts/00_helperFuns.R")



```

```{r , eval=FALSE}
### Load fire dataframe

# source("fire-color/scripts/01.0_pullLakeIDsLAGOS.R")
# source("fire-color/scripts/01.1_pullLakeCat.R")

# source("scripts/01.0_pullLakeIDsLAGOS.R")
# source("scripts/01.1_pullLakeCat.R")
#Currently only pulling out MTBS, FirePerimeters, and ForestLoss, but all the other data is in that R file and commented out for speed. 


##Avoid running all those wrangling scripts
##Last updated on 2022-01-04
lakeCat <- readRDS(here("data_export", "lakeCat.rds"))

#Describes proportion of catchment / watershed within burn perimeters
#But I think I'm missing the burn severity numbers 
MTBS_long <- lakeCat %>%
  dplyr::select(lagoslakeid, nhdplusv2_comid,lake_nhdid,nhdplusv2_reachcode,lake_namegnis,lake_rsvr_class,
                lake_lon_decdeg, lake_lat_decdeg, lake_waterarea_ha, lake_perimeter_m, lake_maxdepth_m, lake_meandepth_m, sumBurn, burn_YN,
                contains("MTBS"))%>%
  pivot_longer(-(1:14), names_pattern = "(\\d+)([A-Za-z]+)", names_to = c("year","scale"))
    # "([A-Za-z]+)" matches only letters, so will pull out just "Ws" or "Cat". "(\\d+)" matches digits and will pull out the year.

```


```{r, eval=FALSE}
### Join burn severity and color data -- save for later
#Read in NHD IDs that Matt sent
HydroLakes_DP_comids <- read.csv("~/Dropbox/dropbox Research/fire-color/data/hydroLakes/HydroLakes_COMID.csv") %>%
  rename(nhdplusv2_comid=comid) %>%
  mutate(nhdplusv2_comid=as.character(as.numeric(nhdplusv2_comid)),
         Hylak_id=as.character(as.numeric(Hylak_id)),
         gnis_id=as.character(as.numeric(gnis_id))) 

HydroLakes_DP_comids<-HydroLakes_DP_comids %>%
  # separate(id, c("name","Hylak_id"),sep="nhdwaterbody.")%>%
  dplyr::select(Hylak_id, nhdplusv2_comid, gnis_id, gnis_name, meandepth, maxdepth)


#Remove possible dupicates
HydroLakes_DP_comids_trim<- HydroLakes_DP_comids %>%
  distinct(nhdplusv2_comid, .keep_all=TRUE) 
# str(HydroLakes_DP_comids_trim)
#How many unique lakes?
# length(unique(HydroLakes_DP_comids_trim$nhdplusv2_comid))

#Read in HydroLakes color stuff
srCor<-read_feather('~/Dropbox/dropbox Research/fire-color/data/hydroLakes/srCorrected_us_hydrolakes_dp_20200628.feather') %>%
  mutate(Hylak_id=as.character(as.numeric(Hylak_id))) 
# str(srCor)

#Join HydroLakes_DP_comids_trim to srCor so we have COMID 
srCor_comid<-inner_join(srCor, HydroLakes_DP_comids, by="Hylak_id")
#How many unique lakes?
# length(unique(srCor_comid$nhdplusv2_comid))

srCor_comid_NAfree<-srCor_comid %>%
  drop_na(nhdplusv2_comid) %>%
  mutate(year=as.character(as.numeric(year)))
#How many unique lakes?
length(unique(srCor_comid_NAfree$nhdplusv2_comid))

MTBS_severe<-MTBS_long %>%
  filter(value>90)%>%
  filter(scale=="Cat") %>%
  dplyr::select(nhdplusv2_comid,lake_waterarea_ha,value,year) %>%
  rename(yearBurn=year) %>%
  group_by(nhdplusv2_comid) %>%
  arrange(yearBurn) %>%
  slice(which.max(value))  # There are a handful of lakes that burned multiple times; select just the BIGGEST burn which likely has the biggest impact.
  # filter(row_number()==1) #There are a handful of lakes that burned multiple times; select just the FIRST burn which likely has the biggest impact.

## There will be 329 sites when we add the lakes between 4-10 ha


MTBS_moderate<-MTBS_long %>%
  filter(value>=1)%>%
  filter(scale=="Cat") %>%
  dplyr::select(nhdplusv2_comid,lake_waterarea_ha,value,year) %>%
  rename(yearBurn=year) %>%
  group_by(nhdplusv2_comid) %>%
  arrange(yearBurn) %>%
  slice(which.max(value))  # There are a handful of lakes that burned multiple times; select just the BIGGEST burn which likely has the biggest impact.
  # filter(row_number()==1) #There are a handful of lakes that burned multiple times; select just the FIRST burn which likely has the biggest impact.
# length(unique(MTBS_moderate$nhdplusv2_comid))

#Find all the lakes that never burned
MTBS_noburn <- MTBS_long %>%
  group_by(nhdplusv2_comid) %>%
  filter(sum(value)==0) %>%
  filter(scale=="Cat") %>%
  dplyr::select(nhdplusv2_comid, lake_waterarea_ha)


colorSevereBurn<-left_join(MTBS_severe,srCor_comid_NAfree,by="nhdplusv2_comid") %>%
  drop_na(dWL) 
  # mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"),
  #        year=as.numeric(as.character(year)))
#How many unique lakes?
# length(unique(colorSevereBurn$nhdplusv2_comid))
# head(colorSevereBurn$yearBurn)

colorModtoSevereBurn<-left_join(MTBS_moderate,srCor_comid_NAfree,by="nhdplusv2_comid") %>%
  drop_na(dWL) 
#How many unique lakes?
# length(unique(colorModtoSevereBurn$nhdplusv2_comid))

colorNoBurn<-left_join(MTBS_noburn,srCor_comid_NAfree,by="nhdplusv2_comid") %>%
  drop_na(dWL) 
#How many unique lakes?
# length(unique(colorNoBurn$nhdplusv2_comid))


## Select 500 lakes that never burned that have a similar distribution of lake area as burned lakes
# grouped <- colorNoBurn %>%
#   tibble::add_column(group_index = group_indices(.)) 
# unique_groups <- unique(group_indices(grouped))
# sampled_groups <- sample(unique_groups, 500)
# sampled_groups

#https://stackoverflow.com/questions/63326846/sample-from-data-frame-based-on-distribution
MTBS_allsites <- MTBS_long %>%
  filter(scale=="Cat") %>%
  group_by(nhdplusv2_comid,lake_lon_decdeg,lake_lat_decdeg,lake_waterarea_ha,lake_perimeter_m) %>%
  slice(which.max(value)) %>%
  mutate(burn_type = case_when(value == 0 ~ "unburned",
                                 value > 0 ~ "burned")) %>%
  left_join(.,srCor_comid_NAfree,by="nhdplusv2_comid") %>% # add this in so we keep only the sites with color data
  drop_na(dWL) 


area <- MTBS_allsites$lake_waterarea_ha[MTBS_allsites$burn_type == "burned"]
dist.fun.area <- approxfun(density(area))

colorNoBurn_subset_names <- MTBS_allsites %>%
  group_by(burn_type) %>% 
  slice_sample(n = 1000, weight_by = dist.fun.area(lake_waterarea_ha)) %>%
  ungroup() %>%
  filter(burn_type=="unburned")

length(unique(colorNoBurn_subset_names$nhdplusv2_comid))
length(unique(MTBS_allsites$nhdplusv2_comid[MTBS_allsites$burn_type == "unburned"]))


colorNoBurn_subset <- colorNoBurn %>%
  filter(nhdplusv2_comid %in% colorNoBurn_subset_names$nhdplusv2_comid)

#Double check that the distributions look similar
hist(log10(colorNoBurn_subset$lake_waterarea_ha))
hist(log10(colorModtoSevereBurn$lake_waterarea_ha))
hist(log10(MTBS_allsites$lake_waterarea_ha[MTBS_allsites$burn_type == "burned"]))
hist(log10(MTBS_allsites$lake_waterarea_ha[MTBS_allsites$burn_type == "unburned"]))





save(colorSevereBurn, colorModtoSevereBurn, MTBS_moderate, MTBS_severe, MTBS_long, file = 'data_export/rbeast_data.RData')
save(colorNoBurn, colorNoBurn_subset, file="data_export/noBurn.RData")

# write_feather(colorNoBurn_subset, "data_export/colorNoBurn_subset.feather")


## Export for Xiao and Michael

#For unburned lakes, there are like 20,000+ total, so let's get a subset of different size classes

#What if we want to sample a distribution of lakes that didn't burn that matches lakes that did burn...?
MTBS_allsites <- MTBS_long %>%
  filter(scale=="Cat") %>%
  group_by(nhdplusv2_comid,lake_lon_decdeg,lake_lat_decdeg,lake_waterarea_ha,lake_perimeter_m) %>%
  slice(which.max(value)) %>%
  mutate(burn_type = case_when(value == 0 ~ "unburned",
                                 value > 0 ~ "burned")) %>%
  left_join(., lakeCat %>% select(nhdplusv2_comid,lake_elevation_m)) 
  # summarize(total_area_burned=sum(value,na.rm=TRUE)) %>%
  #   mutate(burn_type = case_when(total_area_burned == 0 ~ "unburned",
  #                                total_area_burned > 0 ~ "burned"))

MTBS_allsites %>%
  group_by(burn_type) %>%
  count()

#How does the distribution of lake sizes look between the two?
MTBS_allsites %>%
  ggplot(aes(x=log10(lake_waterarea_ha)))+
  geom_histogram()+
  facet_wrap(burn_type~., scales="free_y")
#Honestly pretty similar but let's take a subsample of the unburned sites that has a lake area distribution matching the unburned sites


#https://stackoverflow.com/questions/63326846/sample-from-data-frame-based-on-distribution
area <- MTBS_allsites$lake_waterarea_ha[MTBS_allsites$burn_type == "burned"]
dist.fun.area <- approxfun(density(area))

MTBS_subset_area <- MTBS_allsites %>%
  group_by(burn_type) %>% 
  slice_sample(n = 5000, weight_by = dist.fun.area(lake_waterarea_ha)) %>%
  ungroup()

MTBS_subset_area %>%
  group_by(burn_type) %>%
  count()


#Now how does the distribution look?
MTBS_subset_area %>%
  ggplot(aes(x=log10(lake_waterarea_ha)))+
  geom_histogram()+
  facet_wrap(burn_type~.) +
MTBS_subset_area %>%
  ggplot(aes(x=log10(lake_perimeter_m)))+
  geom_histogram()+
  facet_wrap(burn_type~.)  



length(unique(MTBS_subset_area$nhdplusv2_comid))
#7410

#How many sites do we drop if we specify that the lake has to be 90m on a side?
# less<-MTBS_subset %>%
#   filter(lake_perimeter_m >=282)
# length(unique(less$nhdplusv2_comid))
#none. we are fine.

MTBS_subset_area %>%
  group_by(burn_type) %>%
  count()

MTBS_subset_export <- MTBS_subset_area %>%
  dplyr::select(nhdplusv2_comid, lake_nhdid, nhdplusv2_reachcode, lake_lat_decdeg, lake_lon_decdeg, lake_waterarea_ha, lake_perimeter_m, burn_YN, value, year) %>%
  rename(perc_burn=value,
         year_burn=year) %>%
  mutate(burn_YN=recode(burn_YN, "severeBurn"="burned"))

MTBS_subset_export %>%
  group_by(burn_YN) %>%
  count()

head(MTBS_subset_export)

write.csv(MTBS_subset_export, "data_export/westernUSlakes_greaterthan1ha_unburnedsubset.csv")



```

```{r, eval=FALSE}
# base::load('fire-color/data_export/rbeast_data.RData')
# base::load('fire-color/data_export/noBurn.RData')


base::load('data_export/rbeast_data.RData')
base::load('data_export/noBurn.RData')
# rm(colorNoBurn, colorSevereBurn, MTBS_severe)



```

# BEAST model (>1% burn)

I created a set of functions that extract some of the most relevant parameters from the model, like a dataframe of predicted dWL values and a list of trend or seasonal changepoints with their corresponding 95% credible intervals and the probabilities associated with the changepoints. This is just a start, as there are possibly other parameters we may want to extract such as the slope of the trend. 

## Functions for all models 
```{r, echo=TRUE,  results=FALSE, message=FALSE, warning=FALSE, class.source = 'fold-show'}



##########################################################################################
##Functions for monster Rbeast model
##########################################################################################

#Run the actual Rbeast model
map_beast <- function(df) {
  mod = beast.irreg(df$dWL,
                    time = df$date,
                    deltat = 1 / 12,
                    freq = 12,
                    mcmc.seed = 9999)
}

#Extract trend changepoints
map_tcps <- function(mod) {
  # tcps<-
  data.frame(mod$trend$cp,
             mod$trend$cpCI,
             mod$trend$cpPr,
             mod$trend$cpAbruptChange) %>%
    drop_na() %>%
    rename(
      tcp_Date = 1,
      tcp_CI_low = 2,
      tcp_CI_high = 3,
      cpPR = 4,
      cpAbruptChange = 5
    ) %>%
    mutate(sign=case_when(cpAbruptChange > 0 ~ "positive",
                          TRUE ~ "negative"))
}

#Create dataframe of predicted dWL with trend changepoint occurance prob. at any given point in time
map_pred_tcps <- function(mod) {
  data.frame(mod$trend$Y,
             mod$trend$CI,
             mod$time,
             mod$trend$cpOccPr) %>%
    rename(
      dWL_pred = 1,
      dWL_pred_CI_high = 2,
      dWL_pred_CI_low = 3,
      date_dec = 4,
      tcpOccPr = 5
    ) %>%
    # mutate(date = as.Date(date))
    mutate(date_dec = as.Date(date_decimal(date_dec)))
}

#Extract seasonal changepoints
map_scps <- function(mod) {
  data.frame(mod$season$cp,
             mod$season$cpCI,
             mod$season$cpPr) %>%
    drop_na() %>%
    rename(
      scp_Date = 1,
      scp_CI_low = 2,
      scp_CI_high = 3,
      scpPr = 4
    )
}

#Create dataframe of predicted dWL with seasonal changepoint occurance prob. at any given point in time
map_pred_scps <- function(mod) {
  data.frame(
    mod$season$Y,
    mod$season$CI,
    mod$time,
    mod$season$cpOccPr,
    mod$season$amp,
    mod$season$ampSD
  ) %>%
    rename(
      dWL_season = 1,
      dWL_pred_CI_high = 2,
      dWL_pred_CI_low = 3,
      date_dec = 4,
      scpOccPr = 5,
      amp = 6,
      amp_sd = 7
    ) %>%
    mutate(date_dec = as.Date(date_decimal(date_dec)))
}

```

Here I am going to run the model and include any lake that burned >= 1% of the local catchment.
```{r, echo=TRUE,  results=FALSE, message=FALSE, warning=FALSE, eval=FALSE, class.source = 'fold-show'}

colorModtoSevereBurn_trim <- colorModtoSevereBurn %>%
  mutate(
    month = month(date),
    year = year(date),
    doy = yday(date),
    yearBurn = ymd(sprintf("%d-07-01", as.numeric(
      as.character(yearBurn)
    )))
  ) %>%
  filter(value>=1) %>% #Lakes over 5% burn
  mutate(dWL = replace(dWL, dWL < 470, NA),
         dWL = replace(dWL, dWL > 583, NA)) %>%
  drop_na(dWL) %>%
  group_by(nhdplusv2_comid, year) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(fire_period = case_when(date <= yearBurn ~ "pre_fire",
                                 date > yearBurn ~ "post_fire")) %>%
  group_by(nhdplusv2_comid, fire_period) %>%
  mutate(unique_years = n_distinct(year)) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(pre_and_post = length(unique(fire_period))) %>%
  filter(pre_and_post == 2) %>% #require both pre- and post-fire data
  pivot_wider(
    names_from = "fire_period",
    values_from = "unique_years",
    names_prefix = "years_",
    values_fn = mean
  ) %>% #Need to add values_fn to suppress duplicates warning
  unnest(c(years_post_fire, years_pre_fire)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(min(years_pre_fire, na.rm = TRUE) >= 5 &
           min(years_post_fire, na.rm = TRUE) >= 5) %>%
  select(
    nhdplusv2_comid,
    yearBurn,
    date,
    year,
    month,
    doy,
    dWL,
    pre_and_post,
    years_post_fire,
    years_pre_fire
  ) %>%
  ungroup()

#How many lakes that burned over 1% or 5%
length(unique(colorModtoSevereBurn_trim$nhdplusv2_comid))


```
We have `r length(unique(colorModtoSevereBurn_trim$nhdplusv2_comid))` lakes to start with this time. 

## Run BEAST
```{r, echo=TRUE,  results=FALSE, message=FALSE, warning=FALSE, eval=FALSE}



start_time <- Sys.time()
set.seed(1111)
nested_beast <- colorModtoSevereBurn_trim %>%
  as_tibble() %>%
  ungroup() %>%
  arrange(date) %>%
  group_by(year, month, nhdplusv2_comid) %>%
  distinct(date, .keep_all = TRUE) %>%
  summarize(median = median(dWL, na.rm = TRUE)) %>%
  na.trim() %>%
  ungroup() %>%
  group_by(nhdplusv2_comid) %>%
  transmute(date = ymd(paste(year, month, "01", sep = "-")),
            dWL = median) %>%
  mutate(yearmonth = yearmonth(date)) %>% #need to index by yearmonth
  as_tsibble(., key = nhdplusv2_comid, index = yearmonth) %>% #time series tibble
  fill_gaps() %>% #makes the missing data implicit
  select(-date) %>%
  mutate(date = as.Date(yearmonth)) %>%
  as_tibble() %>%
  select(-yearmonth) %>%
  group_by(nhdplusv2_comid) %>%
  nest() %>%
  # filter(nhdplusv2_comid=="20328576")%>%
  mutate(
    beast = purrr::map(data, map_beast),
    tcps = purrr::map(beast, map_tcps),
    scps = purrr::map(beast, map_scps),
    pred_tcps = purrr::map(beast, map_pred_tcps),
    pred_scps = purrr::map(beast, map_pred_scps)
  ) 
gc()#Free up memory
end_time <- Sys.time()
# save(nested_beast, file="data_export/nested_beast_20220505.RData") #This version is all 275 lakes that burned over 5% watershed area
save(nested_beast, colorModtoSevereBurn_trim, MTBS_moderate, file="data_export/nested_beast_20220701.RData") #This version is all 314 lakes that burned over 1% watershed area
```

```{r}
# base::load('data_export/nested_beast_20220505.RData') #This version is all 275 lakes that burned over 5% watershed area
base::load('data_export/nested_beast_20220701.RData') #This version is all 314 lakes that burned over 1% watershed area
```


## Invetigate num. of changepoints

Here I am using the following criteria:

- The high end of the 95% credible intervals must be within 5 years (inclusive) of the burn
- The trend changepoint can be up to 1 year prior to the burn AND
- The trend changepoint date cannot be no more than 5 years **past** the year of the burn.


```{r, class.source = 'fold-show'}
fire_trend_changes_over5 <- nested_beast %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  full_join(MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
  mutate(
    fire_cp = case_when(
      tcp_CI_high - yearBurn <= 5 & #Consider setting back to 5
        #Make sure the upper bound of the tcp is within 5 years of the burn
        # tcp_Date >= yearBurn - 1 & #Using this cut off and including a year before the fire captures a lot more lakes
        tcp_Date >= yearBurn & #using this cut-off captures fewer lakes but might make more sense. 
        #tcp_Date can be up to 1 year before yearBurn
        abs(yearBurn - tcp_Date) <= 5 ~ 'fire change',
      #BUT no more than 5 years PAST yearBurn
      TRUE ~ "change not associated with fire"
    )
  )


counts <- fire_trend_changes_over5 %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  group_by(`cpPR > 0.5`) %>%
  summarize(n = length(unique(nhdplusv2_comid)))
```

For `r sum(counts$n)` lakes, we detect at least one changepoint within 5 years of the fire. For `r counts%>%pluck(2,2)` of those lakes, the probability is quite high (>0.5). So approximately `r round(sum(counts$n)/length(unique(nested_beast$nhdplusv2_comid)),2)*100`% of the lakes show a color change in response to fire. 


```{r}
fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(changepoint_number==1)%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), y=cpPR, fill=mcp))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity", position="dodge", color="black", width=0.75)+
  scale_fill_manual(values=c("#595cff","#c6f8ff"),
                    name="Multiple\nchangepoints?")+
  geom_text(aes(label=round(cpPR,2)), vjust=-1  , hjust=-0.2, size=2, angle=45) +
  labs(y="Trend changepoint occurance probability",
       x="COMID",
       title="All lakes where >1 % of the watershed burned")+
  theme(axis.text.x=element_text(size=6))
# ggsave("figures/n_changepoints_per_lake.jpg", width = 16, height = 8, units = 'in')
```

```{r}
fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(mcp=="yes")%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), y=cpPR, fill=changepoint_number))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity", position="dodge", color="black", width=0.75)+
  scale_fill_manual(values=c("#4361EE","#3A0CA3","#7209B7","#F72585","grey50"),
                    name="Changepoint number")+
  geom_text(aes(label=round(cpPR,2)), vjust=-1, hjust=-0.4, size=2, angle=45, position = position_dodge(0.9)) +
  labs(y="Trend changepoint occurance probability",
       x="COMID",
       title="Where >1 % of the watershed burned AND there are multiple changepoints within 5 years of burn")+
  theme(axis.text.x=element_text(size=6))


fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(mcp=="no")%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), y=cpPR, fill=changepoint_number))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity", position="dodge", color="black", width=0.75)+
  geom_text(aes(label=round(cpPR,2)), vjust=-1, hjust=-0.4, size=2, angle=45, position = position_dodge(0.9)) +
  labs(y="Trend changepoint occurance probability",
       x="COMID",
       title="Where >1 % of the watershed burned AND there only 1 changepoint within 5 years")+
  theme(axis.text.x=element_text(size=6),
        legend.position="none")
# 
# ggsave("figures/lakes_with_mcp.jpg", width = 16, height = 8, units = 'in')
```


# BEAST model (0% burn)

One of the things Sarah and I discussed was simulating random "fake fires" through a subset of unburned lakes and seeing how many of those lakes detected a change. That might further bolster this proof of concept. Say 10% of the lakes have a changepoint within 5 years of a hypothetical fire, that's a fairly low false positive rate. In any case, let's give it a whirl.

## Create df of lakes that didn't burn
```{r, eval=F}

# set.seed(5555)
# #Randomly generate yearBurn for each lake 
# IDs <- colorNoBurn_subset %>%
#   distinct(nhdplusv2_comid) %>%
#   pull()
# DATEs <- sample(seq(as.Date('1991/07/01'), as.Date('2005/07/01'), by="day"), length(IDs))
# randomBurns <- data.frame(IDs,DATEs) %>%
#   rename(nhdplusv2_comid=IDs,
#          yearBurn=DATEs)

#Alternative way: what is the distribution of burn years? 
set.seed(4905)

#Get the distribution of actual burns
realBurns <- colorModtoSevereBurn_trim %>%
  distinct(nhdplusv2_comid, .keep_all = TRUE) %>%
  mutate(yearBurn=year(yearBurn)) %>%
  pull(yearBurn)

#Get the IDs for unburned sites
IDs <- colorNoBurn_subset %>%
  distinct(nhdplusv2_comid) %>%
  pull()

#Simulate burn years from the distribution of actual burns, with the same length as IDs
YEARs <- sample(realBurns, size=length(IDs), replace=TRUE)

#Do the histograms match?
hist(realBurns)
hist(YEARs)
#Yes!

randomBurns <- data.frame(IDs,YEARs) %>%
  rename(nhdplusv2_comid=IDs,
         yearBurn=YEARs) %>%
  mutate(yearBurn = ymd(sprintf("%d-07-01", as.numeric(yearBurn)))) #make it a date

colorNoBurn_trim <- colorNoBurn_subset %>% 
  inner_join(randomBurns)%>%
  mutate(
    month = month(date),
    year = year(date),
    doy = yday(date)
  ) %>%
  mutate(dWL = replace(dWL, dWL < 470, NA),
         dWL = replace(dWL, dWL > 583, NA)) %>%
  drop_na(dWL) %>%
  group_by(nhdplusv2_comid, year) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(fire_period = case_when(date <= yearBurn ~ "pre_fire",
                                 date > yearBurn ~ "post_fire")) %>%
  group_by(nhdplusv2_comid, fire_period) %>%
  mutate(unique_years = n_distinct(year)) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(pre_and_post = length(unique(fire_period))) %>%
  filter(pre_and_post == 2) %>% #require both pre- and post-fire data
  pivot_wider(
    names_from = "fire_period",
    values_from = "unique_years",
    names_prefix = "years_",
    values_fn = mean
  ) %>% #Need to add values_fn to suppress duplicates warning
  unnest(c(years_post_fire, years_pre_fire)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(min(years_pre_fire, na.rm = TRUE) >= 5 &
           min(years_post_fire, na.rm = TRUE) >= 5) %>%
  select(
    nhdplusv2_comid,
    yearBurn,
    date,
    year,
    month,
    doy,
    dWL,
    pre_and_post,
    years_post_fire,
    years_pre_fire
  ) %>%
  ungroup()



```

## Run BEAST
```{r, eval=F}

start_time <- Sys.time()
set.seed(1111)
nested_beast_noBurn <- colorNoBurn_trim %>%
  as_tibble() %>%
  ungroup() %>%
  arrange(date) %>%
  group_by(year, month, nhdplusv2_comid) %>%
  distinct(date, .keep_all = TRUE) %>%
  summarize(median = median(dWL, na.rm = TRUE)) %>%
  na.trim() %>%
  ungroup() %>%
  group_by(nhdplusv2_comid) %>%
  transmute(date = ymd(paste(year, month, "01", sep = "-")),
            dWL = median) %>%
  mutate(yearmonth = yearmonth(date)) %>% #need to index by yearmonth
  as_tsibble(., key = nhdplusv2_comid, index = yearmonth) %>% #time series tibble
  fill_gaps() %>% #makes the missing data implicit
  select(-date) %>%
  mutate(date = as.Date(yearmonth)) %>%
  as_tibble() %>%
  select(-yearmonth) %>%
  group_by(nhdplusv2_comid) %>%
  nest() %>%
  # filter(nhdplusv2_comid=="20328576")%>%
  mutate(
    beast = purrr::map(data, map_beast),
    tcps = purrr::map(beast, map_tcps),
    scps = purrr::map(beast, map_scps),
    pred_tcps = purrr::map(beast, map_pred_tcps),
    pred_scps = purrr::map(beast, map_pred_scps)
  ) %>%
  select(-beast)
end_time <- Sys.time()

round(end_time - start_time,1)

# save(nested_beast_noBurn, file="data_export/nested_beast_noBurn_20220413.RData") #This is randomly simulated burn years
save(nested_beast_noBurn, colorNoBurn_trim, file="data_export/nested_beast_noBurn_20220701.RData") #This is burn years based on a distribution of actual burns
```


## Investigate
```{r}

# load('data_export/nested_beast_noBurn_20220413.RData')#This is randomly simulated burn years
load('data_export/nested_beast_noBurn_20220701.RData') #This is burn years based on a distribution of actual burns


fakefire_trends <- nested_beast_noBurn %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  left_join(., colorNoBurn_trim %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = decimal_date(yearBurn)) %>%
  distinct(nhdplusv2_comid, .keep_all=TRUE) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
  mutate(
    fire_cp = case_when(
      tcp_CI_high - yearBurn <= 5 & #Consider setting back to 5
        #Make sure the upper bound of the tcp is within 5 years of the burn
        # tcp_Date >= yearBurn - 1 & #Using this cut off and including a year before the fire captures a lot more lakes
        tcp_Date >= yearBurn & #using this cut-off captures fewer lakes but might make more sense. 
        #tcp_Date can be up to 1 year before yearBurn
        abs(yearBurn - tcp_Date) <= 5 ~ 'fire change',
      #BUT no more than 5 years PAST yearBurn
      TRUE ~ "change not associated with fire"
    )
  )

##Note: when I switched it from 5 years to 3 years the percentage went from 11 to 9%. So not too different. 

counts <- fakefire_trends %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  group_by(`cpPR > 0.5`) %>%
  summarize(n = length(unique(nhdplusv2_comid)))


fakefire_trends %>%
  filter(fire_cp=="fire change") %>%
  ggplot(aes(x=cpAbruptChange)) +
  geom_histogram(colour="black", fill="white", bins=50)+
  cowplot::theme_half_open() +
  labs(title="All changepoints in all lakes - simulated burns") +

#Look at only the 1st changepoint
fakefire_trends %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  filter(changepoint_number==1) %>%
  ggplot(aes(x=cpAbruptChange)) +
  geom_histogram(colour="black", fill="white", bins=50)+
  cowplot::theme_half_open() +
  labs(title="First changepoint in all lakes - simulated burns")



```

For `r sum(counts$n)` lakes, we detect at least one changepoint within 5 years of the fire. For `r counts%>%pluck(2,2)` of those lakes, the probability is quite high (>0.5). So approximately `r round(sum(counts$n)/length(unique(colorNoBurn_trim$nhdplusv2_comid)),2)*100`% of the lakes show a color change in response to fire. 


```{r, eval=F}
fakefire_trends %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number)))%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), y=cpPR, fill=changepoint_number))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity", position="dodge",  color="black", width=0.75)+
  # geom_text(aes(label=round(cpPR,2)), vjust=-1  , hjust=-0.2, size=3, angle=45) +
  labs(y="Trend changepoint occurance probability",
       x="COMID",
       title="Lakes with fake burns (n=500)")+
    scale_fill_manual(values=c("grey20","grey40","grey70","grey90"))+
  theme(legend.position="bottom")

#Are there multiple changepoints?
fakefire_trends %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(mcp=="yes")%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), y=cpPR, fill=changepoint_number))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity", position="dodge", color="black", width=0.75)+
  scale_fill_manual(values=c("#4361EE","#3A0CA3","#7209B7","#F72585","grey50"),
                    name="Multiple\nchangepoints?")+
  geom_text(aes(label=round(cpPR,2)), vjust=-1, hjust=-0.4, size=2, angle=45, position = position_dodge(0.9)) +
  labs(y="Trend changepoint occurance probability",
       x="COMID",
       title="Where >1 % of the watershed burned AND there are multiple changepoints within 5 years of burn")+
  theme(axis.text.x=element_text(size=6))
#There are NOT multiple changepoints for any of the simulated burn lakes, which is a very good sign. 


```


# Summarize BEAST results

## Proportion bar chart
What proportion of lakes in each burn severity class show a sudden change in color?

```{r}
BurnClassCount_unburned <-fakefire_trends %>%
  mutate(burnSeverityClass = "0%") %>%
  group_by(nhdplusv2_comid, burnSeverityClass, fire_cp) %>%
  summarize(n=n()) %>%
  pivot_wider(names_from = fire_cp,
              values_from = n) %>%
  mutate(`fire change`=replace_na(`fire change`, 0)) %>%# Replace NAs to zeros
  mutate(firechange =
           ifelse(`fire change` >= 1, "yes",
                  ifelse(`fire change` < 1, "no", "error"))) %>%
  mutate(firechange=factor(firechange,
                           levels=c("no","yes")))%>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") 


## Burned sites
BurnClassCount_burned<-fire_trend_changes_over5 %>%
  full_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
  filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>% 
  # slice(which.max(value)) %>% # We have duplicate rows of observations and this picks just the year of the burn
  mutate(burnSeverityClass = cut(value, breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                 labels = c("1-10%","10-20%","20-30%","30-40%","40-50%","50-60%",
                                            "60-70%","70-80%","80-90%","90-100%"),
                                 ordered_result = TRUE)) %>%
  group_by(nhdplusv2_comid, burnSeverityClass, fire_cp) %>%
  summarize(n=n()) %>%
  pivot_wider(names_from = fire_cp,
              values_from = n) %>%
  mutate(`fire change`=replace_na(`fire change`, 0)) %>%# Replace NAs to zeros
  mutate(firechange =
           ifelse(`fire change` >= 1, "yes",
                  ifelse(`fire change` < 1, "no", "error"))) %>%
  mutate(firechange=factor(firechange,
                           levels=c("no","yes")))%>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") 


#Dummy data for no burn sites -- I have this analysis below but it takes long to run.
#The "false positive rate" is 11%
# length(unique(colorNoBurn$nhdplusv2_comid))
# burnSeverityClass <- c("No burn","No burn")
# firechange <- c("yes","no")
# prop_change <- c(0.11,0.89)
# noBurnCount<-data.frame(burnSeverityClass,
#                         firechange,
#                         prop_change) %>%
#   mutate(firechange=factor(firechange,
#                            levels=c("no","yes")))


# Stacked barplot with proportions
BurnClassCount_burned %>%
  bind_rows(.,BurnClassCount_unburned) %>%
  group_by(burnSeverityClass, firechange, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_burnClass) %>%
  ggplot(aes(fill = firechange, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values = c("#0a2463","#fb3640"),
                    labels = c("No response","Change in dWL detected"),
                    name = "")+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes")+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5)  +

# Barplots with counts
BurnClassCount_burned %>%
  # bind_rows(.,BurnClassCount_unburned) %>%
  group_by(burnSeverityClass, firechange, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  ggplot(aes(fill = firechange, y = n_lakes_changed, x = burnSeverityClass)) +
  geom_bar(color="black", position = "dodge", stat = "identity") +
  scale_fill_manual(values = c("#0a2463","#fb3640"),
                    labels = c("No response","Change in dWL detected"),
                    name = "")+
  labs(x="Burn severity class (% of local catchment)",
       y="Number of lakes")+
  plot_layout(guides = 'collect')


#How many total lakes across the dataset shifted?
BurnClassCount_burned %>%
  group_by(firechange) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  pivot_wider(names_from=firechange, values_from = n_lakes_changed) %>%
  rename(no_change_n=no,
         yes_change_n=yes) %>%
  mutate(total_n=no_change_n+yes_change_n,
         prop_no=no_change_n/total_n,
         prop_yes=yes_change_n/total_n)


#How many total lakes across each burn class shifted?
BurnClassCount_burned %>%
  bind_rows(.,BurnClassCount_unburned) %>%
  group_by(firechange,burnSeverityClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  pivot_wider(names_from=firechange, values_from = n_lakes_changed) %>%
  rename(no_change_n=no,
         yes_change_n=yes) %>%
  mutate(total_n=no_change_n+yes_change_n,
         prop_no=no_change_n/total_n,
         prop_yes=yes_change_n/total_n)

```

A look at the lakes that burned >1% of the watershed area and experienced a change in DWL.

```{r}
firetrendlakes_over5<-fire_trend_changes_over5 %>%
           filter(fire_cp=="fire change")

nested_beast %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% firetrendlakes_over5$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by="nhdplusv2_comid") %>%
  left_join(., firetrendlakes_over5 %>% select(nhdplusv2_comid, cpPR, fire_cp)) %>%
    mutate(dWL=round(dWL, digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(tcps)) %>%
                  filter(tcp_CI_low %in% firetrendlakes_over5$tcp_CI_low),
  aes(xmin = tcp_CI_low, xmax = tcp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Points for raw dWL
  geom_point(aes(x=decimal_date(date), y=dWL,color=color), alpha=0.8, size=1)+
  scale_color_identity() +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)),
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(tcps)) %>%
                filter(tcp_CI_low %in% firetrendlakes_over5$tcp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(tcp_Date), format = "%Y"))),
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  # geom_richtext(data=firetrendlakes_over5,
  #                 aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("cpPR=", round(cpPR,1))),
  #               stat = "unique", color="black", fill="#f9dcc4", size=2)+
  facet_wrap(~fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), scales="free_y")+
  theme(strip.text.x = element_textbox(size=10,fill = "grey40", box.color = "#000000"))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year",
       title="Lakes that burned >1% of the watershed area",
       subtitle="We detect at least one changepoint within 5 years of the fire in 152 lakes")+
  cowplot::panel_border() +
  cowplot::background_grid()


ggsave("figures/all_lakes_with_changepoints.jpg", width = 16, height = 12, units = 'in')

```

Wow, that's a bit overwhelming. 

## Lakes with multiple changepoints

Let's look a little more closely at these sites

```{r}

  
mcp_subset<-fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  filter(!changepoint_number==1)
length(unique(mcp_subset$nhdplusv2_comid))


mcp_subset <- fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(mcp=="yes")


mcp_pred_subset<-
nested_beast %>%
      filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) 


nested_beast %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by="nhdplusv2_comid") %>%
  left_join(., mcp_subset %>% select(nhdplusv2_comid, cpPR, fire_cp)) %>%
  mutate(dWL=round(dWL, digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(tcps)) %>%
                  filter(tcp_CI_low %in% mcp_subset$tcp_CI_low),
  aes(xmin = tcp_CI_low, xmax = tcp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Points for raw dWL
  geom_point(aes(x=decimal_date(date), y=dWL,color=color),  size=1)+
  scale_color_identity() +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(tcps)) %>%
                filter(tcp_CI_low %in% mcp_subset$tcp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(tcp_Date), format = "%Y"))), 
                linetype="dashed", size=0.5)+
    #Add confidence intervals around the dwl trend
  # geom_ribbon(
  #   data=mcp_pred_subset,
  #   aes(
  #     ymin = (dWL_pred_CI_low),
  #     ymax = (dWL_pred_CI_high),
  #     x = as.Date(date_dec)
  #   ),
  #   inherit.aes = FALSE,
  #   fill = "grey50",
  #   alpha = 0.4
  # ) +
  # #Add line for predicted dwl trend
  # geom_line(
  #   data=mcp_pred_subset,
  #   aes(x = as.Date(date_dec), y = dWL_pred)
  # ) +
  #Add the cpPR on each panel
  # geom_richtext(data=mcp_subset,
  #                 aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("cpPR=", round(cpPR,1))),
  #               stat = "unique", color="black", fill="#f9dcc4", size=2)+
  facet_wrap(~fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), scales="free_y")+
  theme(strip.text.x = element_textbox(size=10,fill = "grey40", box.color = "#000000"))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year",
       title="Lakes that burned >1% of the watershed area",
       subtitle="AND have multiple changepoints within 5 years of burn")+
  cowplot::panel_border() +
  cowplot::background_grid()

# ggsave("figures/mcp_lakes_with_changepoints.jpg", width = 16, height = 12, units = 'in')






nested_beast %>%
  select(nhdplusv2_comid, data) %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  left_join(
    .,
    nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
      rename(date = date_dec),
    by = c("nhdplusv2_comid", "date")
  ) %>%
  inner_join(., MTBS_moderate %>%
               select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  left_join(., mcp_subset %>% select(nhdplusv2_comid, cpPR, fire_cp)) %>%
    mutate(dWL=round(dWL, digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  group_by(nhdplusv2_comid) %>%
  distinct(date, .keep_all = TRUE) %>% #For some reason a million duplicates were showing up
  ungroup()%>%
  group_by(nhdplusv2_comid) %>%
  mutate(dWL_pred=zoo::na.approx(dWL_pred, na.rm=FALSE),
         dWL_pred_CI_high=zoo::na.approx(dWL_pred_CI_high, na.rm=FALSE),
         dWL_pred_CI_low=zoo::na.approx(dWL_pred_CI_low, na.rm=FALSE))%>% #Need to interpolate values for plotting
  ggplot() +
  facet_wrap( ~ fct_reorder(nhdplusv2_comid, cpPR, .desc = TRUE), scales =
                "free_y", ncol=4) +
  #Add confidence intervals around changepoint
  geom_rect(
    data = nested_beast %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% mcp_subset$tcp_CI_low),
    aes(
      xmin = tcp_CI_low,
      xmax = tcp_CI_high,
      ymin = -Inf,
      ymax = Inf
    ),
    color = "pink",
    fill = "pink"
  ) +
    #Points for raw dWL
  geom_point(aes(x = decimal_date(date), y = dWL, color = color),
             size = 1.5) +
  scale_color_identity() +
  #Add CI around fitted trend
  geom_ribbon(aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = decimal_date(date)
  ),
  inherit.aes = FALSE,
  alpha=0.9,
  fill = "#dee2ff") +
  #Add line for predicted dwl trend
  geom_line(aes(x = decimal_date(date), y = dWL_pred), color="#8e9aaf") +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)),
             color = "red",
             size = 0.5) +
  #Add vertical line for exact trend changepoint
  geom_vline(
    data = nested_beast %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% mcp_subset$tcp_CI_low),
    aes(xintercept = decimal_date(as.Date(
      as.character(tcp_Date), format = "%Y"
    ))),
    linetype = "dashed",
    size = 0.5
  ) +
  #Add the cpPR on each panel
  geom_richtext(
    data = mcp_subset,
    aes(
      x = -Inf,
      y = Inf,
      hjust = -0.1,
      vjust = 1.5,
      label = paste0("cpPR=", round(cpPR, 1))
    ),
    stat = "unique",
    color = "black",
    fill = "#f9dcc4",
    size = 2
  ) +
  theme(strip.text.x = element_textbox(
    size = 10,
    fill = "grey40",
    box.color = "#000000"
  )) +
  labs(y = "Observed dominant wavelength (nm)",
       x = "Year",
       title = "Lakes where >1% of the watershed burned",
       subtitle ="Only sites with multiple changepoints") +
  cowplot::panel_border() +
  cowplot::background_grid()

# ggsave("figures/04_all_lakes_with_mcp.jpg", width = 18, height = 32, units = 'in')
```

All sites with a SINGLE changepoint
```{r}
mcp_subset<-fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(mcp=="no")

length(unique(mcp_subset$nhdplusv2_comid))

mcp_pred_subset<-
nested_beast %>%
      filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) 

nested_beast %>%
  select(nhdplusv2_comid, data) %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  left_join(
    .,
    nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% mcp_subset$nhdplusv2_comid) %>%
      rename(date = date_dec),
    by = c("nhdplusv2_comid", "date")
  ) %>%
  inner_join(., MTBS_moderate %>%
               select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  left_join(., mcp_subset %>% select(nhdplusv2_comid, cpPR, fire_cp)) %>%
    mutate(dWL=round(dWL, digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  group_by(nhdplusv2_comid) %>%
  distinct(date, .keep_all = TRUE) %>% #For some reason a million duplicates were showing up
  ungroup()%>%
  group_by(nhdplusv2_comid) %>%
  mutate(dWL_pred=zoo::na.approx(dWL_pred, na.rm=FALSE),
         dWL_pred_CI_high=zoo::na.approx(dWL_pred_CI_high, na.rm=FALSE),
         dWL_pred_CI_low=zoo::na.approx(dWL_pred_CI_low, na.rm=FALSE))%>% #Need to interpolate values for plotting
  ggplot() +
  facet_wrap( ~ fct_reorder(nhdplusv2_comid, cpPR, .desc = TRUE), scales =
                "free_y", ncol=4) +
  #Add confidence intervals around changepoint
  geom_rect(
    data = nested_beast %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% mcp_subset$tcp_CI_low),
    aes(
      xmin = tcp_CI_low,
      xmax = tcp_CI_high,
      ymin = -Inf,
      ymax = Inf
    ),
    color = "pink",
    fill = "pink"
  ) +
    #Points for raw dWL
  geom_point(aes(x = decimal_date(date), y = dWL, color = color),
             size = 1.5) +
  scale_color_identity() +
  #Add CI around fitted trend
  geom_ribbon(aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = decimal_date(date)
  ),
  inherit.aes = FALSE,
  alpha=0.9,
  fill = "#dee2ff") +
  #Add line for predicted dwl trend
  geom_line(aes(x = decimal_date(date), y = dWL_pred), color="#8e9aaf") +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)),
             color = "red",
             size = 0.5) +
  #Add vertical line for exact trend changepoint
  geom_vline(
    data = nested_beast %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% mcp_subset$tcp_CI_low),
    aes(xintercept = decimal_date(as.Date(
      as.character(tcp_Date), format = "%Y"
    ))),
    linetype = "dashed",
    size = 0.5
  ) +
  #Add the cpPR on each panel
  geom_richtext(
    data = mcp_subset,
    aes(
      x = -Inf,
      y = Inf,
      hjust = -0.1,
      vjust = 1.5,
      label = paste0("cpPR=", round(cpPR, 1))
    ),
    stat = "unique",
    color = "black",
    fill = "#f9dcc4",
    size = 2
  ) +
  theme(strip.text.x = element_textbox(
    size = 10,
    fill = "grey40",
    box.color = "#000000"
  )) +
  labs(y = "Observed dominant wavelength (nm)",
       x = "Year",
       title = "Lakes where >5% of the watershed burned",
       subtitle ="Only sites with a single changepoint") +
  cowplot::panel_border() +
  cowplot::background_grid()

ggsave("figures/04b_all_lakes_with_one_changpt.jpg", width = 18, height = 32, units = 'in')

```


### Case studies / closer look

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("22971746")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("22971746"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_low < yearBurn + years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22971746")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22971746")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x",ncol=4)+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  labs(y="Dominant wavelength",
       x="Year",
       title="Mud Lake, Montana (near Flathead)")


```

Here is an example of a lake that experiences a sudden change in dWL followed by a quick recovery. For this lake the model detects two very high probability changepoints (>0.9) within 5 years of the burn. It looks like a sharp dip in dWL followed by a quick recovery. LAGOS-US classifies this as a natural lake but I wonder what would cause the lake to go suddenly, but temporarily, blue when it is generally a green lake? 

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("120052904")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("120052904"))
    ) %>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("120052904")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("120052904")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix")

ggsave("figures/TDR_lake_ts.jpg", width = 6, height = 6, units = 'in')
```

Another case where there is a sudden change followed by a partial recovery and gradual increase to pre-fire levels. AFTER that, there is another sudden drop. It is a reservoir, however, so it's possible that management me also have to do with some of these patterns. 

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("23062152")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("23062152"))
    ) %>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("23062152")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("23062152")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Unnamed lake, Montana near N. Dakota Border")

ggsave("figures/Unnamed_MT_lake_ts.jpg", width = 6, height = 6, units = 'in')
```

Here is a small reservoir on the plains of Montana near the N. Dakota Border. HWere we see a sudden greening followed by recovery post-fire. What's interesting here is that fire wasn't very large. In 2007, 10% of the watershed burned. Interestingly, in 2017 20% of the watershed burned again, and you can see a bit of a blip in color too. 

Currently I have the model coded to only look for changepoints around the FIRST fire in each lake. But perhaps we should explore changepoints on each individual fire? 

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("22971850")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("22971850"))
    ) %>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22971850")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22971850")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Lena Lake, a high elevation natural lake east of Flathead")
ggsave("figures/LenaLake_ts.jpg", width = 8, height = 8, units = 'in')
```

Another case where the changepoint is sudden with a fair recovery. Although the confidence interval on the first changepoint is wide, the changepoint occurance probability is very high for both the first and second changepoints (0.99 and 0.98 respectively).

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("9305106")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("9305106"))
    ) %>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Red Eagle Lake, Glacier National Park")
```

Here's a lake with the largest short-term increase in dWL.

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("24089096")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("24089096"))
    ) %>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("24089096")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("24089096")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Hawkes Lake (Reservoir) Oregon")
ggsave("figures/HawkesLake_rsvr_ts.jpg", width = 8, height = 8, units = 'in')

```

Our interpretation of reservoir data will be potentially trick. 

```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("23280640")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("23280640"))
    ) %>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("23280640")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("23280640")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Walker Reservoir, ID, has 2 changepoints basically right on top of each other",
       subtitle="If you google it, it's a nasty cattle pond. ")

```




```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("4263072")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("4263072"))
    ) %>%
  mutate(dWL=round(dWL, digits=0))%>% 
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("4263072")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("4263072")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Fox lake, MT, Yellowstone Region")
ggsave("figures/FoxLake_MT_ts.jpg", width = 8, height = 8, units = 'in')



```


```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("22954099")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("22954099"))
    ) %>%
  mutate(dWL=round(dWL, digits=0))%>% 
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
      #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22954099")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22954099")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
  labs(title="Middle Quartz Lake, MT, Glacier NP")
ggsave("figures/MiddleQuartzLake_MT_ts.png", width = 8, height = 8, units = 'in')

```


## Strength of cpPR by burn severity
Below I'm not sure it makes sense to include the 0% class since there are so many more samples. Kind of misleading. Can just comment this out.
```{r}
add_noBurn <-fakefire_trends %>%
  mutate(burnSeverityClass = "0%") %>%
  filter(fire_cp=="fire change")

fire_trend_changes_over5 %>%
  full_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
  filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>%
  # slice(which.max(value)) %>% # We have duplicate rows of observations and this picks just the year of the burn
  mutate(burnSeverityClass = cut(
    value,
    breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
    labels = c(
      "1-10%",
      "10-20%",
      "20-30%",
      "30-40%",
      "40-50%",
      "50-60%",
      "60-70%",
      "70-80%",
      "80-90%",
      "90-100%"
    ),
    ordered_result = TRUE
  )) %>%
    filter(fire_cp=="fire change")%>%
  bind_rows(.,add_noBurn) %>%
  ggplot(aes(x = burnSeverityClass, y = cpPR, fill = burnSeverityClass)) +
  geom_violin() +
  geom_jitter(
    shape = 21,
    color = "black",
    size = 1.5,
    width = 0.1
  ) +
  scale_fill_discrete_sequential(palette = "Reds") +
  theme(legend.position = "none",
        plot.title = element_text(size = 11)) +
  labs(y = "Trend changepoint occurance probability",
       x = "Burn severity class (% of local catchment)") 



fire_trend_changes_over5 %>%
  full_join(
    ., MTBS_moderate %>% mutate(yearBurn=as.numeric(as.character(yearBurn)))
  ) %>% 
    filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>%
  mutate(burnSeverityClass = cut(value, breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                 labels = c("1-10%","10-20%","20-30%","30-40%","40-50%","50-60%",
                                            "60-70%","70-80%","80-90%","90-100%"),
                                 ordered_result = TRUE)) %>%
  ungroup() %>%
    bind_rows(.,add_noBurn) %>%
  filter(fire_cp=="fire change")%>%
    mutate(cpPR_Class = cut(
    cpPR,
    breaks = c(0.0,0.25,0.50,0.75,1),
    ordered_result = FALSE
  )) %>%
  mutate(cpPR_Class=factor(cpPR_Class,
                           levels=c("(0.75,1]","(0.5,0.75]",
                                    "(0.25,0.5]","(0,0.25]")))%>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") %>%
  group_by(burnSeverityClass, cpPR_Class) %>%
  add_count(name="n_class_type") %>%
    group_by(burnSeverityClass, cpPR_Class, n_class_type) %>%
  summarize(prop_cat=n_class_type/n_per_burnClass) %>%
  distinct(burnSeverityClass, cpPR_Class, .keep_all = TRUE) %>%
  ggplot(aes(fill = cpPR_Class, y = prop_cat, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values = c("#4f0000","#781f1f","#ba3f3f","#ffa14a"),
                    name = "Changepoint occurance probability:")+
geom_text(aes(label= paste0("n=", n_class_type)), color="white", vjust=1.3, position = "fill", stat = "identity", size=3)+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes") + theme(legend.position="top")+
  guides(fill = guide_legend(reverse = TRUE)) #Change order of factors on legend without altering the plot

# ggsave("figures/tcp_probability_by_burnSeverity.jpg", width = 11, height = 6, units = 'in', dpi=600)
```

### Magnitude of tcp by burn severity

```{r}
fire_trend_changes_over5 %>%
  full_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
  filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>%
  # slice(which.max(value)) %>% # We have duplicate rows of observations and this picks just the year of the burn
  mutate(burnSeverityClass = cut(
    value,
    breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
    labels = c(
      "1-10%",
      "10-20%",
      "20-30%",
      "30-40%",
      "40-50%",
      "50-60%",
      "60-70%",
      "70-80%",
      "80-90%",
      "90-100%"
    ),
    ordered_result = TRUE
  )) %>%
    filter(fire_cp=="fire change")%>%
  ggplot(aes(x = burnSeverityClass, y = cpAbruptChange, fill = burnSeverityClass)) +
  geom_violin() +
  geom_jitter(
    shape = 21,
    color = "black",
    size = 1.5,
    width = 0.1
  ) +
  scale_fill_discrete_sequential(palette = "Reds") +
  theme(legend.position = "none",
        plot.title = element_text(size = 11)) +
  labs(y = "Magnitude of dWL change (nm)",
       x = "Burn severity class (% of local catchment)")
# ggsave("figures/tcp_magnitude_by_burnSeverity.jpg", width = 6, height = 6, units = 'in', dpi=600)
```

## Typology


### How did color change?
```{r}
fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  ggplot(aes(x=cpAbruptChange)) +
  geom_histogram(colour="black", fill="white", bins=50)+
  cowplot::theme_half_open() +
  labs(title="All changepoints in all lakes") +

#Look at only the 1st changepoint
fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  filter(changepoint_number==1) %>%
  ggplot(aes(x=cpAbruptChange)) +
  geom_histogram(colour="black", fill="white", bins=50)+
  cowplot::theme_half_open() +
  labs(title="First changepoint in all lakes")


#Is there a correlation between cpAbruptChange and 

fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  filter(cpAbruptChange<100) %>%
  ggplot(aes(x=abs(cpAbruptChange), y=cpPR))+
  geom_point()

##What if we only look at lakes with cpAbruptChange >= 10?
#Look at only the 1st changepoint
fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  filter(changepoint_number==1) %>%
  filter(abs(cpAbruptChange)>10) %>%
  ggplot(aes(x=cpAbruptChange)) +
  geom_histogram(colour="black", fill="white", bins=50)+
  cowplot::theme_half_open() +
  labs(title="First changepoint in all lakes",
       subtitle="Only changes of > 10 nm in dWL")


```

#### Lakes with mcp
```{r}

## How do changes occur in each lake type? 

fire_trend_changes_over5 %>%
  filter(fire_cp=="fire change") %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number))) %>%
  mutate(mcp = case_when(length(unique(changepoint_number)) > 1 ~ "yes",
                         TRUE ~ "no")) %>%
  filter(mcp=="yes") %>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpAbruptChange, .desc= TRUE), y=cpAbruptChange, fill=sign, group=cpAbruptChange))+
  geom_bar(stat="identity", position="dodge", color="black", width=0.75)+
  scale_fill_manual(values=c("lightblue","forestgreen"),
                    name="Sign of change")+
  labs(y="Magnitude of Change in DWL (nm)",
       x="COMID",
       title="In lakes with multiple changepoints, how did color respond?")+
  theme(axis.text.x=element_text(size=6))
# ggsave("figures/mcp_responses.jpg", width = 8, height = 6, units = 'in', dpi=600)
```

# Manually calculate abrupt change
##### 1 year before and after fire
```{r}

#First, get the 1st fire changepoint for every lake
first_fire<-  fire_trend_changes_over5 %>%
    # mutate(dWL_pred=round(dWL_pred, digits=0))%>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  ungroup() %>%
  filter(fire_cp=="fire change") %>%
  arrange(nhdplusv2_comid, tcp_Date) %>%
  group_by(nhdplusv2_comid, fire_cp) %>%
  filter(row_number()==1)


raw_dwl_change<-nested_beast %>%
  select(nhdplusv2_comid, data) %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% first_fire$nhdplusv2_comid) %>%
  left_join(., first_fire, by="nhdplusv2_comid") %>%
  #Retain only 1 year before and after the changepoint date
  filter(date <= tcp_Date + years(1)) %>%
  filter(date > tcp_Date - years(1)) %>%
  #Create manual AbruptChange calculation
  mutate(
    changepoint_timeperiod = case_when(
      date <= tcp_Date ~ 'before changepoint',
      date > tcp_Date ~ 'after changepoint'
    )
  ) %>%
  group_by(nhdplusv2_comid, changepoint_timeperiod) %>%
  summarize(median_dWL_raw=median(dWL, na.rm=TRUE)) %>%
  pivot_wider(names_from=changepoint_timeperiod,
              values_from=median_dWL_raw)%>%
  mutate(cpAbruptChange_raw = `after changepoint` - `before changepoint`)


pred_dwl_change<-nested_beast %>%
  select(nhdplusv2_comid, pred_tcps) %>%
  unnest(c(pred_tcps))  %>%
  filter(nhdplusv2_comid %in% first_fire$nhdplusv2_comid) %>%
  left_join(., first_fire, by="nhdplusv2_comid") %>%
  #Retain only 1 year before and after the changepoint date
  filter(date_dec <= tcp_Date + years(1)) %>%
  filter(date_dec > tcp_Date - years(1)) %>%
  #Create manual AbruptChange calculation
  mutate(
    changepoint_timeperiod = case_when(
      date_dec <= tcp_Date ~ 'before changepoint',
      date_dec > tcp_Date ~ 'after changepoint'
    )
  ) %>%
  group_by(nhdplusv2_comid, changepoint_timeperiod) %>%
  summarize(median_dWL_pred=median(dWL_pred, na.rm=TRUE)) %>%
  pivot_wider(names_from=changepoint_timeperiod,
              values_from=median_dWL_pred) %>%
  mutate(cpAbruptChange_pred = `after changepoint` - `before changepoint`)


# Are the predicted and raw dwl changes comparable?
left_join(raw_dwl_change,pred_dwl_change, by="nhdplusv2_comid") %>%
  ggplot(aes(x=cpAbruptChange_raw,y=cpAbruptChange_pred))+
  geom_point()

#Are predicted comparable to the model output?
left_join(first_fire,pred_dwl_change, by="nhdplusv2_comid") %>%
  ggplot(aes(x=cpAbruptChange,y=cpAbruptChange_pred))+
  geom_point()

#Are raw comparable to the model output?
left_join(first_fire,raw_dwl_change, by="nhdplusv2_comid") %>%
  ggplot(aes(x=cpAbruptChange,y=cpAbruptChange_raw))+
  geom_point()

#Any relationship between the magnitude of raw dWL change and burn severity class?
raw_dwl_change %>%
  left_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
  group_by(nhdplusv2_comid)  %>%
  mutate(burnSeverityClass = cut(
    value,
    breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
    labels = c(
      "1-10%",
      "10-20%",
      "20-30%",
      "30-40%",
      "40-50%",
      "50-60%",
      "60-70%",
      "70-80%",
      "80-90%",
      "90-100%"
    ),
    ordered_result = TRUE
  )) %>%
    mutate(
    sign = case_when(
      cpAbruptChange_raw > 0 ~ 'positive',
      cpAbruptChange_raw <= 0 ~ 'negative'
    )
  )%>%
  filter(sign %in% c("positive","negative")) %>%
  ggplot(aes(x = burnSeverityClass, y = cpAbruptChange_raw, fill = burnSeverityClass)) +
  geom_violin() +
  geom_jitter(
    shape = 21,
    color = "black",
    size = 1.5,
    width = 0.1
  ) +
  scale_fill_discrete_sequential(palette = "Reds") +
  theme(legend.position = "none",
        plot.title = element_text(size = 11)) +
  labs(y = "Magnitude of dWL change, calculated from raw dWL (nm)",
       x = "Burn severity class (% of local catchment)")+
    facet_wrap(~sign)

#As a continuous relationship?
raw_dwl_change %>%
  left_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
    mutate(
    sign = case_when(
      cpAbruptChange_raw > 0 ~ 'positive',
      cpAbruptChange_raw <= 0 ~ 'negative'
    )
  )%>%
  filter(sign %in% c("positive","negative")) %>%
  ggplot(aes(x = value, y = cpAbruptChange_raw)) +
  geom_point(size=3,shape=21)+
  labs(y = "Magnitude of dWL change, calculated from raw dWL (nm)",
       x = "% watershed burn")+
  geom_smooth(method="lm",se=FALSE)+
  facet_wrap(~sign, scales="free_y")



#Any relationship between the magnitude of predicted dWL change and burn severity class?
pred_dwl_change %>%
  left_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
  group_by(nhdplusv2_comid)  %>%
  mutate(burnSeverityClass = cut(
    value,
    breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
    labels = c(
      "1-10%",
      "10-20%",
      "20-30%",
      "30-40%",
      "40-50%",
      "50-60%",
      "60-70%",
      "70-80%",
      "80-90%",
      "90-100%"
    ),
    ordered_result = TRUE
  )) %>%
    mutate(
    sign = case_when(
      cpAbruptChange_pred > 0 ~ 'positive',
      cpAbruptChange_pred <= 0 ~ 'negative'
    )
  )%>%
  filter(sign %in% c("positive","negative")) %>%
  ggplot(aes(x = burnSeverityClass, y = cpAbruptChange_pred, fill = burnSeverityClass)) +
  geom_violin() +
  geom_jitter(
    shape = 21,
    color = "black",
    size = 1.5,
    width = 0.1
  ) +
  scale_fill_discrete_sequential(palette = "Reds") +
  theme(legend.position = "none",
        plot.title = element_text(size = 11)) +
  labs(y = "Magnitude of dWL change, calculated from pred dWL (nm)",
       x = "Burn severity class (% of local catchment)")+
    facet_wrap(~sign)

#As a continuous relationship?
pred_dwl_change %>%
  left_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
    mutate(
    sign = case_when(
      cpAbruptChange_pred > 0 ~ 'positive',
      cpAbruptChange_pred <= 0 ~ 'negative'
    )
  )%>%
  filter(sign %in% c("positive","negative")) %>%
  ggplot(aes(x = value, y = cpAbruptChange_pred)) +
  geom_point(size=3,shape=21)+
  labs(y = "Magnitude of dWL change, calculated from pred dWL (nm)",
       x = "% watershed burn")+
  geom_smooth(method="lm",se=FALSE)+
  facet_wrap(~sign, scales="free_y")
#Stronger relationship between magnitude of dWL change and % watershed burn for negative changes (blueing) but not positive (greening)


#What happens if we filter out relatively low tcp probabilities? Say < 0.5.
pred_dwl_change %>%
  left_join(., MTBS_moderate %>% select(-yearBurn)) %>%
    mutate(
    sign_pred = case_when(
      cpAbruptChange_pred > 0 ~ 'positive',
      cpAbruptChange_pred <= 0 ~ 'negative'
    )
  )%>%
  left_join(., first_fire, by=c("nhdplusv2_comid")) %>%
  filter(sign %in% c("positive","negative")) %>%
  ggplot(aes(x = value, y = cpAbruptChange_pred)) +
  geom_point(size=3,shape=21)+
  labs(y = "Magnitude of dWL change, calculated from pred dWL (nm)",
       x = "% watershed burn")+
  geom_smooth(method="lm",se=FALSE)+
  facet_wrap(~sign, scales="free_y")


```

#### Explore a few lakes
```{r}

#If the abrupt change is small, why is there a tcp?
# Look at a lake with a high cpPR but low cpAbruptChange

  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("22594739")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("22594739"))
    ) %>%
      mutate(dWL=round(dWL, digits=0))%>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22594739")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22594739")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")


#A case where cpAbruptChange is positive, but the calculated chnage is zero
#It turns out the reason for this discrepancy is because the change is very quick (toward green) but the lake seems to recover very quickly too (toward blue)
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("20341411")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("20341411"))
    ) %>%
      mutate(dWL=round(dWL, digits=0))%>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("20341411")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("20341411")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")
  
# A case where the model detects a sudden drop but in the manual calculation it looks like the lake got greener  
fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("22971746")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("22971746"))
    ) %>%
      mutate(dWL=round(dWL, digits=0))%>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  # geom_ribbon(data = nested_beast %>%
  #     select(nhdplusv2_comid, pred_tcps) %>%
  #     unnest(c(pred_tcps)) %>%
  #     filter(nhdplusv2_comid %in% c("22971746")),
  #     aes(
  #   ymin = (dWL_pred_CI_low),
  #   ymax = (dWL_pred_CI_high),
  #   x = as.Date(date_dec)
  # ),
  # inherit.aes = FALSE,
  # fill = "grey50") +
  #   #Add line for predicted dwl trend
  # geom_line(
  #   data = nested_beast %>%
  #     select(nhdplusv2_comid, pred_tcps) %>%
  #     unnest(c(pred_tcps)) %>%
  #     filter(nhdplusv2_comid %in% c("22971746")),
  #   aes(x = as.Date(date_dec), y = dWL_pred)
  # ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")
```

```{r}
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("2963958")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("2963958"))
    ) %>%
      mutate(dWL=round(dWL, digits=0))%>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("2963958")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("2963958")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")

```

```{r}
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("21275888")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("21275888"))
    ) %>%
      mutate(dWL=round(dWL, digits=0))%>%
    left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
    filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("21275888")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("21275888")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_color_identity() +
    #Raw data
    geom_point(aes(color=color))+
    facet_wrap(~nhdplusv2_comid, scale="free_x")

```

# 10 years before/after burn

```{r}
color_normalized<-nested_beast %>%
        select(nhdplusv2_comid, pred_tcps) %>%
        unnest(c(pred_tcps)) %>%
        filter(nhdplusv2_comid %in% fire_trend_changes_over5$nhdplusv2_comid) %>%
  left_join(., fire_trend_changes_over5 %>%
              ungroup() %>%
              select(nhdplusv2_comid, yearBurn, fire_cp, sign, tcp_Date) %>%
              filter(fire_cp == "fire change") %>%
              group_by(nhdplusv2_comid) %>%
              arrange(tcp_Date) %>%
              filter(row_number()==1)) %>%
  mutate(year=year(date_dec)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(year >= yearBurn-10  & year <= yearBurn+10) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(year_norm = case_when(year == yearBurn ~ 0,
                               year == yearBurn - 1 ~ -1,
                               year == yearBurn - 2 ~ -2,
                               year == yearBurn - 3 ~ -3,
                               year == yearBurn - 4 ~ -4,
                               year == yearBurn - 5 ~ -5,
                               year == yearBurn - 6 ~ -6,
                               year == yearBurn - 7 ~ -7,
                               year == yearBurn - 8 ~ -8,
                               year == yearBurn - 9 ~ -9,
                               year == yearBurn - 10 ~ -10,
                               year == yearBurn + 1 ~ 1,
                               year == yearBurn + 2 ~ 2,
                               year == yearBurn + 3 ~ 3,
                               year == yearBurn + 4 ~ 4,
                               year == yearBurn + 5 ~ 5,
                               year == yearBurn + 6 ~ 6,
                               year == yearBurn + 7 ~ 7,
                               year == yearBurn + 8 ~ 8,
                               year == yearBurn + 9 ~ 9,
                               year == yearBurn + 10 ~ 10)) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(dwl_pred_norm = scale(dWL_pred))

#How many lakes with 10 years pre and post fire data?
length(unique(color_normalized$nhdplusv2_comid))
```

#### Visualized burned lakes (neg & pos responses)
```{r}



##ALL DATA
#Extract the median normalized color at year zero
yearZero <-
  color_normalized %>%
  ungroup() %>%
  # filter(year_norm == 0) %>% #year zero
  filter(year_norm > -10 & year_norm < 0) %>%
  group_by(sign) %>%
  summarize(dwl_pred_norm=median(dwl_pred_norm))%>%
  mutate(sign=factor(sign,
                     levels=c("positive","negative"),
                     labels=c("greener","bluer"))) 
  # pull()
color_normalized  %>%
  mutate(sign=factor(sign,
                     levels=c("positive","negative"),
                     labels=c("greener","bluer"))) %>%
  # mutate(year_norm = as.factor(as.numeric(year_norm))) %>%
  ggplot(aes(x=year_norm,y=dwl_pred_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_pred_norm, linetype = sign), yearZero, color="black") +
  geom_boxplot(size=0.5, width=0.5, color="black") +
  facet_wrap(~sign) + 
  scale_fill_manual(values=c('#33a02c','#1f78b4'))+
  scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y=expression(Delta ~ "color (relative to 10-year pre-fire period)"),
       x="Years since fire") 

ggsave("figures/dwl_change_by_sign_allData.png", width = 12, height = 6, units = 'in')


##SEASONAL MEDIAN
yearZero <-
  color_normalized %>%
    mutate(month=month(date_dec)) %>%
  mutate(
    season =
      ifelse(
        month %in% c(10, 11, 12),
        "OND",
        ifelse(
          month %in% c(1, 2, 3),
          "JFM",
          ifelse(
            month %in% c(4, 5, 6),
            "AMJ",
            ifelse(month %in% c(7, 8, 9),
                   "JAS", "error")
          )
        )
      )) %>%
  filter(season=="JAS") %>%
  group_by(nhdplusv2_comid, season, year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  ungroup()%>%
  # filter(year_norm == 0) %>% #year zero
  filter(year_norm > -10 & year_norm < 0) %>%
  group_by(sign) %>%
  summarize(dwl_pred_norm=median(dwl_pred_norm)) %>%
    mutate(sign=factor(sign,
                     levels=c("positive","negative"),
                     labels=c("greener","bluer"))) 

color_normalized  %>%
  mutate(month=month(date_dec)) %>%
  mutate(
    season =
      ifelse(
        month %in% c(10, 11, 12),
        "OND",
        ifelse(
          month %in% c(1, 2, 3),
          "JFM",
          ifelse(
            month %in% c(4, 5, 6),
            "AMJ",
            ifelse(month %in% c(7, 8, 9),
                   "JAS", "error")
          )
        )
      ),
    season = factor(season, 
                    levels=c("OND","JFM","AMJ","JAS"),
                    labels=c("October-December",
                             "January-March",
                             "April-June",
                             "July-September"))) %>%
  filter(season=="July-September")%>%
  mutate(sign=factor(sign,
                     levels=c("positive","negative"),
                     labels=c("greener","bluer"))) %>%
  group_by(nhdplusv2_comid,year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  ggplot(aes(x=year_norm,y=dwl_pred_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_pred_norm, linetype = sign), yearZero, color="black") +
  geom_boxplot(size=0.5, width=0.5, color="black") +
  facet_wrap(sign~.,
             ncol=4) + 
  scale_fill_manual(values=c('#33a02c','#1f78b4'))+
  scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y=expression(Delta ~ "summer color (relative to 10-year pre-fire period)"),
       x="Years since fire") 

ggsave("figures/dwl_change_by_sign_summerMedians.png", width = 12, height = 6, units = 'in')



```

#### Visualized all burned lakes (w/o sudden chngpt)
```{r}

color_normalized_alt<-
  
  colorModtoSevereBurn_trim %>%
  as_tibble() %>%
  ungroup() %>%
  arrange(date) %>%
  group_by(year, month, nhdplusv2_comid) %>%
  distinct(date, .keep_all = TRUE) %>%
  summarize(median = median(dWL, na.rm = TRUE)) %>%
  na.trim() %>%
  ungroup() %>%
  group_by(nhdplusv2_comid) %>%
  transmute(date = ymd(paste(year, month, "01", sep = "-")),
            dWL = median) %>%
  mutate(yearmonth = yearmonth(date)) %>% #need to index by yearmonth
  as_tsibble(., key = nhdplusv2_comid, index = yearmonth) %>% #time series tibble
  fill_gaps() %>% #makes the missing data implicit
  select(-date) %>%
  mutate(date = as.Date(yearmonth)) %>%
  as_tibble() %>%
  select(-yearmonth) %>%
    full_join(MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  mutate(year=year(date)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(year >= yearBurn-10  & year <= yearBurn+10) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(year_norm = case_when(year == yearBurn ~ 0,
                               year == yearBurn - 1 ~ -1,
                               year == yearBurn - 2 ~ -2,
                               year == yearBurn - 3 ~ -3,
                               year == yearBurn - 4 ~ -4,
                               year == yearBurn - 5 ~ -5,
                               year == yearBurn - 6 ~ -6,
                               year == yearBurn - 7 ~ -7,
                               year == yearBurn - 8 ~ -8,
                               year == yearBurn - 9 ~ -9,
                               year == yearBurn - 10 ~ -10,
                               year == yearBurn + 1 ~ 1,
                               year == yearBurn + 2 ~ 2,
                               year == yearBurn + 3 ~ 3,
                               year == yearBurn + 4 ~ 4,
                               year == yearBurn + 5 ~ 5,
                               year == yearBurn + 6 ~ 6,
                               year == yearBurn + 7 ~ 7,
                               year == yearBurn + 8 ~ 8,
                               year == yearBurn + 9 ~ 9,
                               year == yearBurn + 10 ~ 10)) %>%
  mutate(pre_post_fire = case_when(year_norm >= -10 & year_norm < 0 ~ "pre",
                                   year_norm > 0 & year_norm <= 5 ~"post")) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(dwl_norm = scale(dWL))

##ALL DATA
#Extract the pre-fire and post-fire median dWL
sign <-
  color_normalized_alt %>%
  ungroup() %>%
  filter(pre_post_fire %in% c("pre","post")) %>% #year zero
  group_by(nhdplusv2_comid, pre_post_fire) %>%
  summarize(dwl_norm=median(dwl_norm, na.rm=TRUE))%>%
  pivot_wider(names_from=pre_post_fire, values_from=dwl_norm) %>%
  mutate(sign=case_when(post > pre ~ "greener",
                        pre > post ~ "bluer",
                        TRUE ~ "no change")) 

# add back to color_normalized_alt
color_normalized_alt <- left_join(color_normalized_alt, sign, by="nhdplusv2_comid")

#Extract the median normalized color at year zero
yearZero <-
  color_normalized_alt %>%
  ungroup() %>%
  filter(sign %in% c("greener","bluer")) %>%
  filter(year_norm > -10 & year_norm < 0) %>%
  group_by(sign) %>%
  summarize(dwl_norm=median(dwl_norm, na.rm=TRUE))

color_normalized_alt %>%
  select(nhdplusv2_comid, sign) %>%
  distinct(nhdplusv2_comid, sign) %>%
  group_by(sign) %>%
  tally()


#PLOT with 3 possible responses 
color_normalized_alt  %>%
  ggplot(aes(x=year_norm,y=dwl_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_norm, linetype = sign), yearZero) +
  # geom_violin(size=0.5, width=0.5, color="white") +
  geom_boxplot(size=0.5, width=0.5) +
  facet_wrap(~sign) + 
  scale_fill_manual(values=c('#1f78b4','#33a02c',"grey50"))+
  scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y=expression(Delta ~ "color (relative to 10-year pre-fire period)"),
       x="Years since fire") +
  theme(legend.position="none")

ggsave("figures/dwl_change_by_sign_allObs_allLakes.png", width = 12, height = 6, units = 'in')


##SEASONAL MEDIAN
## ALL SITES, even those without sudden changepoints
yearZero <-
  color_normalized_alt %>%
  mutate(month=month(date)) %>%
  mutate(
    season =
      ifelse(
        month %in% c(10, 11, 12),
        "OND",
        ifelse(
          month %in% c(1, 2, 3),
          "JFM",
          ifelse(
            month %in% c(4, 5, 6),
            "AMJ",
            ifelse(month %in% c(7, 8, 9),
                   "JAS", "error")
          )
        )
      )) %>%
  filter(season=="JAS") %>%
  group_by(nhdplusv2_comid, season, year_norm, sign) %>%
  summarize(dwl_norm = median(dwl_norm, na.rm=TRUE)) %>%
  ungroup()%>%
  filter(year_norm > -10 & year_norm < 0) %>%
  filter(sign %in% c("greener","bluer")) %>%
  group_by(sign) %>%
  summarize(dwl_norm=median(dwl_norm, na.rm=TRUE)) %>%
    mutate(sign=factor(sign,
                     # labels=c("bluer","greener"),
                     levels=c("greener","bluer")))

color_normalized_alt %>%
  select(nhdplusv2_comid, sign) %>%
  distinct(nhdplusv2_comid, sign) %>%
  group_by(sign) %>%
  tally()


color_normalized_alt  %>%
  mutate(month=month(date)) %>%
  mutate(
    season =
      ifelse(
        month %in% c(10, 11, 12),
        "OND",
        ifelse(
          month %in% c(1, 2, 3),
          "JFM",
          ifelse(
            month %in% c(4, 5, 6),
            "AMJ",
            ifelse(month %in% c(7, 8, 9),
                   "JAS", "error")
          )
        )
      ),
    season = factor(season, 
                    levels=c("OND","JFM","AMJ","JAS"),
                    labels=c("October-December",
                             "January-March",
                             "April-June",
                             "July-September"))) %>%
  filter(season=="July-September")%>%
  group_by(nhdplusv2_comid,year_norm, sign) %>%
  summarize(dwl_norm = median(dwl_norm, na.rm=TRUE)) %>%
  filter(sign %in% c("greener","bluer")) %>%
  mutate(sign=factor(sign,
                     # labels=c("bluer","greener"),
                     levels=c("greener","bluer")))%>%
  ggplot(aes(x=year_norm,y=dwl_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_norm, linetype = sign), yearZero) +
  geom_boxplot(size=0.5, width=0.5) +
  facet_wrap(sign~.,
             ncol=4) + 
  scale_fill_manual(values=c('#33a02c','#1f78b4'))+
  scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y=expression(Delta ~ "summer color (relative to 10-year pre-fire period)"),
       x="Years since fire") 
ggsave("figures/JASM/dwl_change_by_sign_summerMedians_allLakes.png", width = 12, height = 6, units = 'in')



```

#### Proportion green/blue
##### Abrupt change lakes
```{r}
## Unburned sites
BurnClassCount_unburned <- fakefire_trends %>%
  mutate(burnSeverityClass = "0%") %>%
  group_by(nhdplusv2_comid, burnSeverityClass, fire_cp, sign) %>%
  filter(fire_cp=="fire change")%>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") %>%
  select(-c(tcp_Date:cpAbruptChange,yearBurn,fire_cp))


## Burned sites
BurnClassCount_burned <- fire_trend_changes_over5 %>%
  full_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn)))) %>%
  filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>% 
  # slice(which.max(value)) %>% # We have duplicate rows of observations and this picks just the year of the burn
  mutate(burnSeverityClass = cut(value, breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                 labels = c("1-10%","10-20%","20-30%","30-40%","40-50%","50-60%",
                                            "60-70%","70-80%","80-90%","90-100%"),
                                 ordered_result = TRUE)) %>%
  group_by(nhdplusv2_comid, burnSeverityClass, fire_cp, sign) %>%
  summarize(n=n()) %>%
  pivot_wider(names_from = fire_cp,
              values_from = n) %>%
  mutate(`fire change`=replace_na(`fire change`, 0)) %>%# Replace NAs to zeros
  mutate(firechange =
           ifelse(`fire change` >= 1, "yes",
                  ifelse(`fire change` < 1, "no", "error"))) %>%
  mutate(firechange=factor(firechange,
                           levels=c("no","yes")))%>%
  filter(firechange=="yes") %>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") %>%
  select(-`change not associated with fire`, -`fire change`,-firechange)

# Stacked barplot with proportions
BurnClassCount_burned %>%
  bind_rows(.,BurnClassCount_unburned) %>%
  group_by(burnSeverityClass, sign, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_burnClass) %>%
  mutate(sign=factor(sign,
                     levels=c("negative","positive"),
                     labels=c("bluer","greener")))%>%
  ggplot(aes(fill = sign, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values=c('#1f78b4','#33a02c'),
                    # labels = c("Bluer","Greener"),
                    name = "")+
  geom_text(aes(label= paste0("n=", n_lakes_changed)), color="black", vjust=1.3, position = "fill", stat = "identity", size=3)+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes",
       title="Of the lakes with abrupt color change")+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5) 

```

##### All lakes - approach 1
Using this method, I take the raw data and look at the median lake color in the 5 years before the fire compared to 5 years after the fire. 
```{r}

manual_sign_df <-  
  colorModtoSevereBurn_trim %>%
  as_tibble() %>%
  ungroup() %>%
  arrange(date) %>%
  group_by(year, month, nhdplusv2_comid) %>%
  distinct(date, .keep_all = TRUE) %>%
  summarize(median = median(dWL, na.rm = TRUE)) %>%
  na.trim() %>%
  ungroup() %>%
  group_by(nhdplusv2_comid) %>%
  transmute(date = ymd(paste(year, month, "01", sep = "-")),
            dWL = median) %>%
  mutate(yearmonth = yearmonth(date)) %>% #need to index by yearmonth
  as_tsibble(., key = nhdplusv2_comid, index = yearmonth) %>% #time series tibble
  fill_gaps() %>% #makes the missing data implicit
  select(-date) %>%
  mutate(date = as.Date(yearmonth)) %>%
  as_tibble() %>%
  select(-yearmonth) %>%
    full_join(MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  mutate(year=year(date)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(year >= yearBurn-10  & year <= yearBurn+10) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(year_norm = case_when(year == yearBurn ~ 0,
                               year == yearBurn - 1 ~ -1,
                               year == yearBurn - 2 ~ -2,
                               year == yearBurn - 3 ~ -3,
                               year == yearBurn - 4 ~ -4,
                               year == yearBurn - 5 ~ -5,
                               year == yearBurn - 6 ~ -6,
                               year == yearBurn - 7 ~ -7,
                               year == yearBurn - 8 ~ -8,
                               year == yearBurn - 9 ~ -9,
                               year == yearBurn - 10 ~ -10,
                               year == yearBurn + 1 ~ 1,
                               year == yearBurn + 2 ~ 2,
                               year == yearBurn + 3 ~ 3,
                               year == yearBurn + 4 ~ 4,
                               year == yearBurn + 5 ~ 5,
                               year == yearBurn + 6 ~ 6,
                               year == yearBurn + 7 ~ 7,
                               year == yearBurn + 8 ~ 8,
                               year == yearBurn + 9 ~ 9,
                               year == yearBurn + 10 ~ 10)) %>%
  mutate(pre_post_fire = case_when(year_norm >= -5 & year_norm < 0 ~ "pre",
                                   year_norm > 0 & year_norm <= 5 ~"post")) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(dwl_norm = scale(dWL)) %>%
  ungroup() %>%
  filter(pre_post_fire %in% c("pre","post")) %>% #year zero
  group_by(nhdplusv2_comid, pre_post_fire) %>%
  summarize(dwl_norm=median(dwl_norm, na.rm=TRUE))%>%
  pivot_wider(names_from=pre_post_fire, values_from=dwl_norm) %>%
  mutate(sign=case_when(post > pre ~ "greener",
                        pre > post ~ "bluer",
                        TRUE ~ "no change")) %>%
  full_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn))) %>% select(nhdplusv2_comid,value)) %>%
  full_join(., lakeCat %>% distinct(nhdplusv2_comid, .keep_all=TRUE) %>% select(nhdplusv2_comid, lake_rsvr_class, lake_rsvr_probnl, lake_rsvr_probrsvr)) %>%
  filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>% 
  mutate(burnSeverityClass = cut(value, breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                 labels = c("1-10%","10-20%","20-30%","30-40%","40-50%","50-60%",
                                            "60-70%","70-80%","80-90%","90-100%"),
                                 ordered_result = TRUE)) %>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") %>%
  group_by(burnSeverityClass,lake_rsvr_class) %>%
  add_count(name="n_per_lakeClass") %>%
  select(-c(post,pre,value))


# Stacked barplot with proportions-- of all the lakes that burned, did they get generally greener or bluer in the 5 years post-fire?
manual_sign_df %>%
  # bind_rows(.,BurnClassCount_unburned) %>%
  group_by(burnSeverityClass, sign, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_burnClass) %>%
  mutate(sign=factor(sign,
                     levels=c("no change","bluer","greener")))%>%
  ggplot(aes(fill = sign, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values=c("grey70",'#1f78b4','#33a02c'))+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes",
       title="Of the lakes that burned over 1% WSA")+
  geom_text(aes(label= paste0("n=", n_lakes_changed)), color="black", vjust=1.3, position = "fill", stat = "identity", size=3)+
  # geom_text(aes(label= paste0(round(prop_change*100,1),"%")), color="black", vjust=2.5, position = "fill", stat = "identity", size=3)+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5) 


# Were the greener/bluer lakes generally reservoirs or natural lakes?
manual_sign_df %>%
  filter(lake_rsvr_class %in% c("NL","RSVR"))%>%
  group_by(burnSeverityClass, sign, n_per_lakeClass, lake_rsvr_class) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_lakeClass) %>%
  mutate(sign=factor(sign,
                     levels=c("no change","bluer","greener")))%>%
  ggplot(aes(fill = sign, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values=c("grey70",'#1f78b4','#33a02c'))+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes",
       title="Of the lakes that burned over 1% WSA")+
  geom_text(aes(label= paste0("n=", n_lakes_changed)), color="black", vjust=1.3, position = "fill", stat = "identity", size=3)+
  # geom_text(aes(label= paste0(round(prop_change*100,1),"%")), color="black", vjust=2.5, position = "fill", stat = "identity", size=3)+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5) +
  facet_wrap(lake_rsvr_class~.)
```


##### All lakes - approach 2
Using this method, I take the predicted dwl values (detrended) and look at the median 5 years before and 5 years after the fire
```{r}

manual_sign_long <-  
  nested_beast %>%
  select(nhdplusv2_comid, pred_tcps) %>%
  unnest(pred_tcps) %>%
  full_join(MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  mutate(year=year(date_dec)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(year >= yearBurn-10  & year <= yearBurn+10) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(year_norm = case_when(year == yearBurn ~ 0,
                               year == yearBurn - 1 ~ -1,
                               year == yearBurn - 2 ~ -2,
                               year == yearBurn - 3 ~ -3,
                               year == yearBurn - 4 ~ -4,
                               year == yearBurn - 5 ~ -5,
                               year == yearBurn - 6 ~ -6,
                               year == yearBurn - 7 ~ -7,
                               year == yearBurn - 8 ~ -8,
                               year == yearBurn - 9 ~ -9,
                               year == yearBurn - 10 ~ -10,
                               year == yearBurn + 1 ~ 1,
                               year == yearBurn + 2 ~ 2,
                               year == yearBurn + 3 ~ 3,
                               year == yearBurn + 4 ~ 4,
                               year == yearBurn + 5 ~ 5,
                               year == yearBurn + 6 ~ 6,
                               year == yearBurn + 7 ~ 7,
                               year == yearBurn + 8 ~ 8,
                               year == yearBurn + 9 ~ 9,
                               year == yearBurn + 10 ~ 10)) %>%
  mutate(pre_post_fire = case_when(year_norm >= -5 & year_norm < 0 ~ "pre",
                                   year_norm > 0 & year_norm <= 1 ~"post_1year",
                                   year_norm > 1 & year_norm <= 2 ~"post_2years",
                                   year_norm > 2 & year_norm <= 3 ~"post_3years",
                                   year_norm > 3 & year_norm <= 4 ~"post_4years",
                                   year_norm > 4 & year_norm <= 5 ~"post_5years")) %>%
  filter(pre_post_fire %in% c("pre","post_1year","post_2years","post_3years","post_4years","post_5years")) %>%
  group_by(nhdplusv2_comid, pre_post_fire) %>%
  summarize(dwl_pred=median(dWL_pred, na.rm=TRUE)) %>%
  mutate(pre_post_fire=factor(pre_post_fire,
                              levels=c("pre","post_1year","post_2years","post_3years","post_4years","post_5years"),
                              labels=c("pre_raw","post1year_raw","post2years_raw","post3years_raw","post4years_raw","post5years_raw"))) %>%
  arrange(nhdplusv2_comid,pre_post_fire) %>%
  pivot_wider(names_from=pre_post_fire, values_from=dwl_pred) %>%
  mutate(pre_norm=pre_raw-pre_raw,
         post1year_norm=post1year_raw-pre_raw,
         post2year_norm=post2years_raw-pre_raw,
         post3year_norm=post3years_raw-pre_raw,
         post4year_norm=post4years_raw-pre_raw,
         post5year_norm=post5years_raw-pre_raw) %>%
  pivot_longer(cols=pre_raw:post5year_norm,
               names_to = c("pre_post_fire", "type"), 
               names_sep= "_")




manual_sign_wide<- manual_sign_long %>%
  filter(type=="raw")%>%
  pivot_wider(names_from=pre_post_fire, values_from=value) %>%
  group_by(nhdplusv2_comid)%>%
  transmute(year1=case_when(post1year > pre ~ "greener",
                        pre > post1year ~ "bluer",
                        TRUE ~ "no change"),
            year2=case_when(post2years > pre ~ "greener",
                        pre > post2years ~ "bluer",
                        TRUE ~ "no change"),
            year3=case_when(post3years > pre ~ "greener",
                        pre > post3years ~ "bluer",
                        TRUE ~ "no change"),
            year4=case_when(post4years > pre ~ "greener",
                        pre > post4years ~ "bluer",
                        TRUE ~ "no change"),
            year5=case_when(post5years > pre ~ "greener",
                        pre > post5years ~ "bluer",
                        TRUE ~ "no change")) %>%
  pivot_longer(-1, names_to = "time_period", values_to="mode") %>%
  left_join(., MTBS_moderate %>% mutate(yearBurn = as.numeric(as.character(yearBurn))) %>% select(nhdplusv2_comid,value)) %>%
  left_join(., lakeCat %>% distinct(nhdplusv2_comid, .keep_all=TRUE) %>% select(nhdplusv2_comid, lake_rsvr_class, lake_rsvr_probnl, lake_rsvr_probrsvr)) %>%
  group_by(nhdplusv2_comid)  %>% 
  mutate(burnSeverityClass = cut(value, breaks = c(1, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                 labels = c("1-10%","10-20%","20-30%","30-40%","40-50%","50-60%",
                                            "60-70%","70-80%","80-90%","90-100%"),
                                 ordered_result = TRUE)) %>%
  group_by(burnSeverityClass) %>%
  mutate(n_per_burnClass=length(unique(nhdplusv2_comid))) %>%
  group_by(burnSeverityClass,lake_rsvr_class) %>%
  mutate(n_per_lakeClass=length(unique(nhdplusv2_comid)))
  


# Stacked barplot with proportions-- of all the lakes that burned, did they get generally greener or bluer in the 5 years post-fire?
manual_sign_wide%>%
  # bind_rows(.,BurnClassCount_unburned) %>%
  group_by(burnSeverityClass, time_period, mode, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_burnClass) %>%
  mutate(mode=factor(mode,
                     levels=c("no change","bluer","greener")))%>%
  ggplot(aes(fill = mode, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values=c("grey70",'#1f78b4','#33a02c'))+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes",
       title="Of the lakes that burned over 1% WSA")+
  geom_text(aes(label= paste0("n=", n_lakes_changed)), color="black", vjust=1.3, position = "fill", stat = "identity", size=3)+
  # geom_text(aes(label= paste0(round(prop_change*100,1),"%")), color="black", vjust=2.5, position = "fill", stat = "identity", size=3)+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5) +
  facet_wrap(time_period~.)


# Were the greener/bluer lakes generally reservoirs or natural lakes?
manual_sign_df_2 %>%
  filter(lake_rsvr_class %in% c("NL","RSVR"))%>%
  group_by(burnSeverityClass, sign, n_per_lakeClass, lake_rsvr_class) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_lakeClass) %>%
  mutate(sign=factor(sign,
                     levels=c("no change","bluer","greener")))%>%
  ggplot(aes(fill = sign, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values=c("grey70",'#1f78b4','#33a02c'))+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes",
       title="Of the lakes that burned over 1% WSA")+
  geom_text(aes(label= paste0("n=", n_lakes_changed)), color="black", vjust=1.3, position = "fill", stat = "identity", size=3)+
  # geom_text(aes(label= paste0(round(prop_change*100,1),"%")), color="black", vjust=2.5, position = "fill", stat = "identity", size=3)+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5) +
  facet_wrap(lake_rsvr_class~.)

# What was the magnitude of the change? 
manual_sign_df_2 %>%
  filter(sign %in% c("greener","bluer")) %>%
  ggplot(aes(x=dwl_diff, fill=sign))+
  geom_histogram(color="black") +
  facet_wrap(lake_rsvr_class~.)

```



#### Visualize unburned sites
```{r}
color_normalized_noBurn<-nested_beast_noBurn %>%
        select(nhdplusv2_comid, pred_tcps) %>%
        unnest(c(pred_tcps)) %>%
  left_join(., fakefire_trends %>%
              ungroup() %>%
              select(nhdplusv2_comid, yearBurn, fire_cp, sign, tcp_Date) %>%
              filter(fire_cp == "fire change") %>%
              group_by(nhdplusv2_comid) %>%
              arrange(tcp_Date) %>%
              filter(row_number()==1)) %>%
  mutate(year=year(date_dec),
         yearBurn=round(yearBurn,0)) %>%
  group_by(nhdplusv2_comid) %>%
  filter(year >= yearBurn-10  & year <= yearBurn+10) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(year_norm = case_when(year == yearBurn ~ 0,
                               year == yearBurn - 1 ~ -1,
                               year == yearBurn - 2 ~ -2,
                               year == yearBurn - 3 ~ -3,
                               year == yearBurn - 4 ~ -4,
                               year == yearBurn - 5 ~ -5,
                               year == yearBurn - 6 ~ -6,
                               year == yearBurn - 7 ~ -7,
                               year == yearBurn - 8 ~ -8,
                               year == yearBurn - 9 ~ -9,
                               year == yearBurn - 10 ~ -10,
                               year == yearBurn + 1 ~ 1,
                               year == yearBurn + 2 ~ 2,
                               year == yearBurn + 3 ~ 3,
                               year == yearBurn + 4 ~ 4,
                               year == yearBurn + 5 ~ 5,
                               year == yearBurn + 6 ~ 6,
                               year == yearBurn + 7 ~ 7,
                               year == yearBurn + 8 ~ 8,
                               year == yearBurn + 9 ~ 9,
                               year == yearBurn + 10 ~ 10)) %>%
  group_by(nhdplusv2_comid) %>%
  mutate(dwl_pred_norm = scale(dWL_pred))

#Extract the median normalized color at year zero
yearZero <-
  color_normalized_noBurn %>%
  ungroup() %>%
  filter(year_norm == 0) %>%
  group_by(sign) %>%
  summarize(dwl_pred_norm=median(dwl_pred_norm)) 
  # pull()
color_normalized_noBurn  %>%
  # mutate(year_norm = as.factor(as.numeric(year_norm))) %>%
  ggplot(aes(x=year_norm,y=dwl_pred_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_pred_norm, linetype = sign), yearZero) +
  geom_boxplot(size=0.5, width=0.5) +
  facet_wrap(~sign) + 
  scale_fill_manual(values=c('#1f78b4','#33a02c'))+
    scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y="All dwl datapoints (normalized by lake)",
       x="Years since fire",
       title="Lakes that didn't burn",
       subtitle="where we simulated a 'fake' fire") +
  theme(axis.text.x = element_text(
        angle = 0,
        hjust = 1,
        size = 8
      ))

#Extract the median normalized color at year zero
yearZero <-
  color_normalized_noBurn %>%
  group_by(nhdplusv2_comid, year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  ungroup()%>%
  filter(year_norm == 0) %>%
    group_by(sign) %>%
  summarize(dwl_pred_norm=median(dwl_pred_norm)) 
  # pull()
color_normalized_noBurn  %>%
  # mutate(year_norm = as.factor(as.numeric(year_norm))) %>%
  group_by(nhdplusv2_comid, year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  ggplot(aes(x=year_norm,y=dwl_pred_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_pred_norm, linetype = sign), yearZero) +
  geom_boxplot(size=0.5, width=0.5) +
  facet_wrap(~sign) + 
  scale_fill_manual(values=c('#1f78b4','#33a02c'))+
      scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y="Annual median dwl (normalized by lake)",
       x="Years since fire")+
  theme(axis.text.x = element_text(
        angle = 0,
        hjust = 1,
        size = 8
      ))


```


### explore pos_ and neg_ model output
```{r}

dat<-colorModtoSevereBurn_trim %>%
  filter(nhdplusv2_comid=="20286504") 

mod = beast.irreg(dat$dWL,
                    time = dat$date,
                    deltat = 1 / 12,
                    freq = 12,
                    mcmc.seed = 9999)

# plot(mod, interactive=TRUE)
plot(mod)

plot(mod, vars=c('s','scp','samp','t','tcp','ocp','tslp'))# plot some selected variables in
# Type "?plot.beast" to see
# more about vars
plot(mod, vars=c('st','t','tslp','tcp'),col=c('red','blue','green','purple'),
     main = "COMID 2963958") # specify colors of selected subplots

#What does the trend look like?
slopedf<-  data.frame(mod$trend$Y,
             mod$trend$CI,
             mod$time,
             mod$trend$slp,
             mod$trend$slpSD,
             mod$trend$slpSignPr) %>%
    rename(
      dWL_pred = 1,
      dWL_pred_CI_high = 2,
      dWL_pred_CI_low = 3,
      date_dec = 4,
      slope = 5,
      slopeSD = 6, 
      slopePr = 7
    ) %>%
    # mutate(date = as.Date(date))
    mutate(date_dec = as.Date(date_decimal(date_dec)))

slopedf %>%
  select(date_dec, slopePr, dWL_pred, slope, ) %>%
  pivot_longer(-(1:2)) %>%
  ggplot(aes(x=date_dec, y=value, fill=slopePr))+
  geom_point(size=3, shape=21)+
  facet_wrap(~name, scales="free_y", nrow=2)
  
  
cpDates<-data.frame(mod$trend$cp,
             mod$trend$cpCI,
             mod$trend$cpPr,
             mod$trend$cpAbruptChange) %>%
    drop_na() %>%
    rename(
      tcp_Date = 1,
      tcp_CI_low = 2,
      tcp_CI_high = 3,
      cpPR = 4,
      cpAbruptChange = 5
    ) %>%
  arrange(tcp_Date)
#Burn was in 2012 and 2013 but very small (1.6 and 2.6% of the local catchment)

#So I want to look closely at what is happening around 2005 where we have some pretty high cpPRs...

mod$trend$pos_ncp #Refers to the avg. number of trend changepoints that jump UP (positively) in the trend
mod$trend$neg_ncp #Refers to the avg. number of trend changepoints that jump down (negatively) in the trend

mod$trend$pos_cp # Years where the trend is POSITIVE
mod$trend$neg_cp # Years where the trend is NEGATIVE

mod$trend$pos_cpPr # Probability of that changepoint, should match mod$trend$cpPr...
mod$trend$neg_cpPr # Probability of that changepoint, should match mod$trend$cpPr...

mod$trend$cpAbruptChange # By many units of DWL did the trend change (at a particular changepoint)? 
mod$trend$pos_cpAbruptChange # Pulls out JUST the positive changes

mod$trend$inc_cp # Where the trend SLOPE is increasing
mod$trend$inc_cpPr # Probability of the trend slope increasing
mod$trend$dec_cp # Where the trend SLOPE is decreasing
mod$trend$inc_cpAbruptChange


pos_sign<-data.frame(mod$trend$pos_cp,
                     mod$trend$pos_cpPr,
                     mod$trend$pos_cpAbruptChange) %>%
  rename(tcp_Date = 1,
         cpPR_sign = 2, 
         sign_cpAbruptChange =  3) %>%
  mutate(sign="positive")
neg_sign<-data.frame(mod$trend$neg_cp,
                     mod$trend$neg_cpPr,
                     mod$trend$neg_cpAbruptChange)%>%
  rename(tcp_Date = 1,
         cpPR_sign = 2,
         sign_cpAbruptChange = 3) %>%
  mutate(sign="negative")
sign<-bind_rows(pos_sign, neg_sign) %>%
  drop_na() %>%
  arrange(tcp_Date)

full_join(cpDates, sign)
#There are some matchesn but a few dates without matches...
#And it seems that pos_cpAbruptChange/neg_cpAbruptChange are equivelent to cpAbruptChange

##WTF is the difference in cpAbruptChange, pos_cpAbruptChange/neg_cpAbruptChange, and inc_cpAbruptChange/dec_cpAbruptChange?

slopes_inc <- data.frame(mod$trend$inc_cp,
                         mod$trend$inc_cpPr,
                         mod$trend$inc_cpAbruptChange) %>%
  rename(tcp_Date=1,
         cpPr_slope=2,
         slope_AbruptChange=3) %>%
  mutate(slope="inc")

slopes_dec <- data.frame(mod$trend$dec_cp,
                         mod$trend$dec_cpPr,
                         mod$trend$dec_cpAbruptChange) %>%
  rename(tcp_Date=1,
         cpPr_slope=2,
         slope_AbruptChange=3) %>%
  mutate(slope="dec")

slope<-bind_rows(slopes_inc, slopes_dec) %>%
  drop_na() %>%
  arrange(tcp_Date)

full_join(slope, sign) %>%
  full_join(., cpDates)

################################################
# WHAT I'VE LEARNED             ################
################################################
# These probabilties are equivelent (dec_cpPr,inc_cpPr,neg_cpPr,pos_cpPr,cpPr)
# These values are equivelent (cpAbruptChange, pos_cpAbruptChange, neg_cpAbruptChange) but are different from dec_cpAbruptChange and inc_cpAbruptChange
```


### Wyoming lakes 

```{r}

WY_lakes <- fire_trend_changes_over5 %>%
  left_join(., lakeIDs %>% select(nhdplusv2_comid, lake_namelagos, lake_lat_decdeg, lake_lon_decdeg,
                                  lake_centroidstate)) %>%
  filter(lake_centroidstate=="WY" & fire_cp=="fire change")

WY_lake_names <- WY_lakes %>%
  group_by(nhdplusv2_comid) %>%
  filter(row_number()==1) %>% #pick first observations
  select(nhdplusv2_comid, lake_namelagos)


  
### ALL Wyoming lakes
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% WY_lake_names$nhdplusv2_comid) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% WY_lake_names$nhdplusv2_comid)) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_low < yearBurn + years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% WY_lake_names$nhdplusv2_comid) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% WY_lake_names$nhdplusv2_comid) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_y",ncol=4)+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  # labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix,
  #      Thermalito Forebay (Reservoir), California,
  #      Lake Isabella (Reservoir), California")+
  ##DARK THEME
      # theme(
      #   axis.ticks.y=element_line(color="white"),
      #   axis.ticks.x=element_line(color="white"),
      #   axis.line =element_line(color="white"),
      #   axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
      #   axis.text.y=element_text(size=18,color="white"),
      #   axis.title.x=element_text(size=18,hjust=0.5, color="white"),
      #   axis.title.y=element_text(size=18,hjust=0.5, color="white"),
      #   # panel.border = element_rect(color="white"),
      #   # panel.background= element_rect(fill="black"),
      #   plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
      #   panel.grid.major = element_blank(),
      #   panel.grid.minor = element_blank(),
      #   plot.background = element_rect(fill="#000000",color="black"),
      #   strip.background = element_rect(fill="#000000"),
      #   strip.text = element_text(color="#FFFFFF"))+
  labs(y="Dominant wavelength",
       x="Year")


  
##Just 2966416, Riddle Lake
  
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("2966416")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("2966416"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  left_join(WY_lake_names) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_low < yearBurn + years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("2966416")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("2966416")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~lake_namelagos, scale="free_y",ncol=4)+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
      ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        panel.border = element_rect(color="white"),
        panel.background= element_rect(fill="white"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000")
        # strip.text = element_text(color="#FFFFFF"),
        )+
  labs(y="Dominant wavelength",
       x="Year")

```

### Why do lakes change?

Is there a relationship between % watershed burn and changepoint probability? In other words, does the probability of a trend change in color **increase** as watershed burn area increase? Are smaller lakes more likely to experince a trend change?

```{r, fig.width=8,fig.height=3}
lakeCat <- readRDS("~/Dropbox/dropbox Research/fire-color/data_export/lakeCat.rds")


firetrends_corr <- firetrendlakes_over5 %>%
  ungroup()%>%
  inner_join(lakeCat) %>%
  select(cpPR, yearBurn, CatAreaSqKm, WsAreaSqKm, lake_lat_decdeg, lake_lon_decdeg,
         lake_totalarea_ha, lake_perimeter_m,
         lake_elevation_m, SlopeCat, WetIndexCat) %>%
  mutate(CALA=(CatAreaSqKm*100)/lake_totalarea_ha,
         WALA=(WsAreaSqKm*100)/lake_totalarea_ha) 

firetrendlakes_over5 %>%
  inner_join(., MTBS_moderate %>% select(-yearBurn), by="nhdplusv2_comid") %>%
  rename(perc_burn=value) %>%
  ggplot(aes(x=perc_burn,y=cpPR))+
  geom_point(size=3)+
  labs(x="% watershed burn") +

firetrendlakes_over5 %>%
  inner_join(., MTBS_moderate %>% select(-yearBurn), by="nhdplusv2_comid") %>%
  rename(perc_burn=value) %>%
  ggplot(aes(x=lake_totalarea_ha,y=cpPR))+
  geom_point(size=3)+
  labs(x="Lake surface area (log10 ha)")+
  scale_x_log10()
```

Is cpPR correlated with anything??

```{r}
library("PerformanceAnalytics")
firetrends_corr_NAfree<-firetrends_corr %>% drop_na()
chart.Correlation(firetrends_corr, histogram=TRUE, pch=19)
```

# How confident is RSVR?
```{r}

bluer_NL <- manual_sign_df %>%
  filter(burnSeverityClass=="90-100%" & sign=="bluer" & lake_rsvr_class=="NL")

bluer_NL_data <- fire_trend_changes_over5 %>%
           # filter(fire_cp=="fire change") %>%
  filter(nhdplusv2_comid %in% bluer_NL$nhdplusv2_comid)


#Look more closely at those lakes. 
bluer_NL_data %>%
    full_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% bluer_NL$nhdplusv2_comid)) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(if (fire_cp=="fire change") tcp_Date >= yearBurn - years(1) else TRUE) %>%
  filter(if (fire_cp=="fire change") tcp_CI_low < yearBurn + years(5) else TRUE) %>%
  #unless the changepoint is associated with fire, replace values with NA for easier plotting
  mutate(tcp_Date = replace(tcp_Date, !fire_cp=="fire change", NA),
         tcp_CI_low = replace(tcp_CI_low, !fire_cp=="fire change", NA),
         tcp_CI_high = replace(tcp_CI_high, !fire_cp=="fire change", NA)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% bluer_NL$nhdplusv2_comid) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% bluer_NL$nhdplusv2_comid) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x",ncol=4)+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year",
       title="Lakes that burned 90-100% of the watershed area",
       subtitle="And are all natural lakes according to LAGOS")



```

# .
# .
# .
# Examples for JASM talk
## Reservoirs
```{r}


  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("120052904","10904119","22670080")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("120052904","10904119","22670080"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  mutate(year=year(tcp_Date))%>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
  left_join(lakeIDs %>% select(nhdplusv2_comid, lake_namelagos)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("120052904","10904119","22670080")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("120052904","10904119","22670080")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  # labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix,
  #      Hagerman Reservoir, WY,
  #      Lake Isabella (Reservoir), California")+
  ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        panel.background= element_rect(fill="white"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000")
        # strip.text = element_text(color="#FFFFFF")
        )+
  labs(y="Dominant wavelength",
       x="Year")


ggsave("figures/JASM/Reservoir_examples.jpg", width = 9, height = 4, units = 'in')


#Willow lake (reservoir) & Hagerman Reservoir (WY)
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("23661584","10904119")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("23661584","10904119"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  mutate(year=year(tcp_Date))%>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("23661584","10904119")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("23661584","10904119")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  # labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix,
  #      Thermalito Forebay (Reservoir), California,
  #      Lake Isabella (Reservoir), California")+
  ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        panel.background= element_rect(fill="white"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000")
        # strip.text = element_text(color="#FFFFFF")
        )+
  labs(y="Dominant wavelength",
       x="Year")
ggsave("figures/JASM/Reservoir_WillowOR_HagermanWY.jpg", width = 8, height = 4, units = 'in')
```

## Lakes that get green & recover
```{r}



  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("2966416","22954221","17573833")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("2966416","22954221","17573833"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_low < yearBurn + years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("2966416","22954221","17573833")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("2966416","22954221","17573833")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x",ncol=4)+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  # labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix,
  #      Thermalito Forebay (Reservoir), California,
  #      Lake Isabella (Reservoir), California")+
  ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        panel.background= element_rect(fill="white"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000")
        # strip.text = element_text(color="#FFFFFF")
        )+
  labs(y="Dominant wavelength",
       x="Year")


ggsave("figures/JASM/Greener_but_recover_examples.jpg", width = 9, height = 4, units = 'in')

```

## Lakes that get green & stay green

```{r}
#Big lake, AZ and Dog Lake, OR
  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("20493267","7914969")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("20493267","7914969"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  mutate(year=year(tcp_Date))%>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("20493267","7914969")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("20493267","7914969")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  # labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix,
  #      Thermalito Forebay (Reservoir), California,
  #      Lake Isabella (Reservoir), California")+
  ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        # panel.background= element_rect(fill="black"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000"),
        strip.text = element_text(color="#FFFFFF"))+
  labs(y="Dominant wavelength",
       x="Year")

ggsave("figures/JASM/BigLake_AZ_DogLake_OR.jpg", width = 7, height = 4, units = 'in')




  fire_trend_changes_over5 %>%
    filter(nhdplusv2_comid %in% c("7914969")) %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid %in% c("7914969"))) %>%
    mutate(dWL=round(dWL,digits=0))%>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  mutate(year=year(tcp_Date))%>%
    #Show only the most relevant changepoints, so it's not as distracting
  filter(tcp_Date >= yearBurn - years(1)) %>%
  filter(tcp_CI_high < yearBurn +years(5)) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("7914969")) %>%
      mutate(year=year(date_dec)),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("7914969")) %>%
      mutate(year=year(date_dec)) ,
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    scale_fill_identity() +
    #Raw data
    geom_point(aes(fill=color),color="black",shape=21)+
    facet_wrap(~nhdplusv2_comid, scale="free_x")+
 scale_x_date(
   date_breaks = "6 years", date_labels = "%Y",
              limits = c(as.Date("1984-1-1"), as.Date("2020-12-01")))+
  # labs(title="Theodore Roosevelt Lake (Reservoir); Arizona, near Pheonix,
  #      Thermalito Forebay (Reservoir), California,
  #      Lake Isabella (Reservoir), California")+
  ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        # panel.background= element_rect(fill="black"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000")
        # strip.text = element_text(color="#FFFFFF")
        )+
  labs(y="Dominant wavelength",
       x="Year")
```

## Number of chgpts by burn severity class

```{r}

BurnClassCount<-fire_trend_changes_over5 %>%
  full_join(
    ., MTBS_moderate %>% mutate(yearBurn=as.numeric(as.character(yearBurn)))
  ) %>% 
    filter(nhdplusv2_comid %in% colorModtoSevereBurn_trim$nhdplusv2_comid) %>%
  group_by(nhdplusv2_comid)  %>%
  # slice(which.max(value)) %>% # We have duplicate rows of observations and this picks just the year of the burn
  mutate(burnSeverityClass = cut(value, breaks = c(5, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                                 labels = c("5-10%","10-20%","20-30%","30-40%","40-50%","50-60%",
                                            "60-70%","70-80%","80-90%","90-100%"),
                                 ordered_result = TRUE)) %>%
  group_by(nhdplusv2_comid, burnSeverityClass, fire_cp) %>%
  summarize(n=n()) %>%
  pivot_wider(names_from = fire_cp,
              values_from = n) %>%
  mutate(`fire change`=replace_na(`fire change`, 0)) %>%# Replace NAs to zeros
  mutate(firechange =
           ifelse(`fire change` >= 1, "yes",
                  ifelse(`fire change` < 1, "no", "error"))) %>%
  mutate(firechange=factor(firechange,
                           levels=c("no","yes")))%>%
  group_by(burnSeverityClass) %>%
  add_count(name="n_per_burnClass") 


#Dummy data for no burn sites -- I have this analysis below but it takes long to run.
#The "false positive rate" is 11%
length(unique(colorNoBurn$nhdplusv2_comid))
burnSeverityClass <- c("No burn","No burn")
firechange <- c("yes","no")
prop_change <- c(0.11,0.89)
noBurnCount<-data.frame(burnSeverityClass,
                        firechange,
                        prop_change) %>%
  mutate(firechange=factor(firechange,
                           levels=c("no","yes")))


# Stacked barplot with proportions
BurnClassCount %>%
  group_by(burnSeverityClass, firechange, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  mutate(prop_change=n_lakes_changed/n_per_burnClass) %>%
    # bind_rows(.,noBurnCount) %>%
  ggplot(aes(fill = firechange, y = prop_change, x = burnSeverityClass)) +
  geom_bar(color="black", position = "fill", stat = "identity") +
  scale_fill_manual(values = c("#0a2463","#fb3640"),
                    labels = c("No response","Change in dWL detected"),
                    name = "")+
  labs(x="Burn severity class (% of local catchment)",
       y="Proportion of lakes")+
  geom_hline(yintercept=0.5, color="black", linetype="dashed", size=0.5)  +

# Barplots with counts
BurnClassCount %>%
  group_by(burnSeverityClass, firechange, n_per_burnClass) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid))) %>%
  ggplot(aes(fill = firechange, y = n_lakes_changed, x = burnSeverityClass)) +
  geom_bar(color="black", position = "dodge", stat = "identity") +
  scale_fill_manual(values = c("#0a2463","#fb3640"),
                    labels = c("No response","Change in dWL detected"),
                    name = "")+
  labs(x="Burn severity class (% of local catchment)",
       y="Number of lakes")+
  plot_layout(guides = 'collect') &   ##DARK THEME
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_blank(),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        # panel.background= element_rect(fill="black"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000"),
        strip.text = element_text(color="#FFFFFF"),
        legend.position="top",
        legend.background = element_rect(fill="black"),
        legend.text = element_text(size=14,color="white",face="bold"))


BurnClassCount %>%
  group_by(firechange) %>%
  summarize(n_lakes_changed=length(unique(nhdplusv2_comid)))

ggsave("figures/JASM/tcp_by_burnSeverity.jpg", width = 9, height = 4, units = 'in', dpi=600)
```




## Normalized values
```{r}
##ANNUAL MEDIAN
#Extract the median normalized color at year zero
yearZero <-
  color_normalized %>%
  group_by(nhdplusv2_comid, year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  ungroup()%>%
  filter(year_norm == 0) %>%
  group_by(sign) %>%
  summarize(dwl_pred_norm=median(dwl_pred_norm)) %>%
  mutate(sign=factor(sign,
                     levels=c("positive","negative")))
  # pull()
color_normalized  %>%
  # mutate(year_norm = as.factor(as.numeric(year_norm))) %>%
  group_by(nhdplusv2_comid, year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  mutate(sign=factor(sign,
                     levels=c("positive","negative")))%>%
  ggplot(aes(x=year_norm,y=dwl_pred_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_pred_norm), yearZero, color="white", linetype="dashed") +
  geom_boxplot(size=0.2, width=0.5, color="white") +
  facet_wrap(~sign) + 
  scale_fill_manual(values=c('#33a02c','#1f78b4'))+
  scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y="Annual median dwl (normalized by lake)",
       x="Years since fire",
       title="Annual median")+
  theme_few()+
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white"),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        panel.border = element_rect(color="white"),
        panel.background= element_rect(fill="black"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000"),
        strip.text = element_text(color="#FFFFFF", size=14, face="bold"),
        legend.position="none")

ggsave("figures/JASM/dwl_change_by_sign_annualMedians.png", width = 12, height = 6, units = 'in')



##SEASONAL MEDIAN
yearZero <-
  color_normalized %>%
    mutate(month=month(date_dec)) %>%
  mutate(
    season =
      ifelse(
        month %in% c(10, 11, 12),
        "OND",
        ifelse(
          month %in% c(1, 2, 3),
          "JFM",
          ifelse(
            month %in% c(4, 5, 6),
            "AMJ",
            ifelse(month %in% c(7, 8, 9),
                   "JAS", "error")
          )
        )
      )) %>%
  group_by(nhdplusv2_comid, season, year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  ungroup()%>%
  filter(year_norm == 0) %>%
    group_by(sign) %>%
  summarize(dwl_pred_norm=median(dwl_pred_norm)) 

color_normalized  %>%
  mutate(month=month(date_dec)) %>%
  mutate(
    season =
      ifelse(
        month %in% c(10, 11, 12),
        "OND",
        ifelse(
          month %in% c(1, 2, 3),
          "JFM",
          ifelse(
            month %in% c(4, 5, 6),
            "AMJ",
            ifelse(month %in% c(7, 8, 9),
                   "JAS", "error")
          )
        )
      ),
    season = factor(season, 
                    levels=c("OND","JFM","AMJ","JAS"),
                    labels=c("October-December",
                             "January-March",
                             "April-June",
                             "July-September"))) %>%
  group_by(nhdplusv2_comid, season,year_norm, sign) %>%
  summarize(dwl_pred_norm = median(dwl_pred_norm, na.rm=TRUE)) %>%
  filter(season %in% c("July-September"))%>%
    mutate(sign=factor(sign,
                     levels=c("positive","negative")))%>%
  ggplot(aes(x=year_norm,y=dwl_pred_norm, fill=sign, group=year_norm)) +
  geom_hline(aes(yintercept=dwl_pred_norm), yearZero, color="white", linetype="dashed") +
  geom_boxplot(size=0.2, width=0.5, color="white") +
  facet_wrap(sign~.) +
  scale_fill_manual(values=c('#33a02c','#1f78b4'))+
  scale_x_continuous(breaks=seq(-10,10,1))+
  labs(y="Annual median dwl (normalized by lake)",
       x="Years since fire",
       title="Summer medians")+
      ##DARK THEME
  theme_few()+
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white"),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_text(size=18,hjust=0.5, color="white"),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        panel.border = element_rect(color="white"),
        panel.background= element_rect(fill="black"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000"),
        strip.text = element_text(color="#FFFFFF", size=14, face="bold"),
        legend.position="none")

ggsave("figures/JASM/dwl_change_by_sign_summerMedians.png", width = 12, height = 6, units = 'in')


#How many in each category?
color_normalized %>%
  distinct(nhdplusv2_comid, .keep_all=TRUE) %>%
  group_by(sign) %>%
  count() %>%
  pivot_wider(names_from=sign, values_from=n) %>%
  mutate(total=negative+positive,
         prop_negative=negative/total,
         prop_positive=positive/total)
  

```

##MAPS

```{r}
## SAME AS ABOVE BUT WHOLE WESTERN U.S. for CU JOB TALK
load('~/Dropbox/dropbox Research/rocky-mtn-color/data/lakezones.RData')

head(lakezones)

#Look at ALL the lakes in the study region
lakezones_studyregion <- lakezones %>%
  select(lagoslakeid, lake_namegnis, lake_centroidstate, lake_elevation_m) %>%
  inner_join(lakecharacteristics)  %>%
  inner_join(lagos %>% select(lagoslakeid, lake_lat_decdeg, lake_lon_decdeg)) %>%
  filter(lake_centroidstate %in% c('CO','UT','WY','MT','NM','ID','NV',
                                   'CA','WA','OR','AZ')) 
  # filter(lake_elevation_m >= 1400)

# How many of the lakes are >10 ha in surface area?
lakezones_studyregion %>%
  filter(lake_waterarea_ha >= 10) %>%
  count()

#What proportion of lakes in the regions are small (<10 ha but <4ha) or large (>10 ha)
lakezones_studyregion <- lakezones_studyregion %>%
  filter(lake_waterarea_ha >= 4) %>%
  mutate(
    size_class = case_when(
      lake_waterarea_ha <= 4  ~ ' 4 ha',
      lake_waterarea_ha >= 4 &  lake_waterarea_ha < 10 ~ '4-10 ha',
      TRUE ~ "> 10 ha"
    )
  )

# Total number of lakes in the study region
total_lakes_region<-lakezones_studyregion %>%  
  count()
total_lakes_region

#How many small lakes are over 1600 m?
lakezones_studyregion %>%
  filter(lake_elevation_m > 1600) %>%
  group_by(size_class) %>%
  count()

# Total lakes either small (4-10 ha) or large (> 10 ha) 
lake_size_proportions<-lakezones_studyregion %>%  
  group_by(size_class) %>%
  count()
lake_size_proportions


#Ok, wow. So the proportion of total lakes that are large is:
lake_size_proportions[1,2]/(total_lakes_region)
#Alternatively, the proportion of total lakes that are small (4-10) is:
lake_size_proportions[2,2]/(total_lakes_region)

## Join with MTBS_long to get the categorical variable of whether or not the lake burned
MTBS_long_new <- MTBS_long %>%
  mutate(burn_YN= 
           ifelse(sumBurn > 0 & sumBurn <= 100, "burned",
                         ifelse(sumBurn <= 0, "unburned", "unburned")))


lakezones_studyregion2 <- left_join(lakezones_studyregion, MTBS_long_new %>%
                                    select(lagoslakeid,nhdplusv2_comid,burn_YN)) %>%
  distinct(nhdplusv2_comid, .keep_all=TRUE) %>%
  mutate(burn_YN=replace_na(burn_YN, 'unburned')) %>% # Replace NAs to zeross
  select(lake_lon_decdeg, lake_lat_decdeg, burn_YN,  size_class) 


## How many lakes burned in each size class?
# Total lakes either small (4-10 ha) or large (> 10 ha) 
lake_size_proportions_burn<-lakezones_studyregion2 %>%  
  group_by(size_class,burn_YN) %>%
  count()
lake_size_proportions_burn


##MAKE MAPS -- first only lakes > 10 ha
png(filename = 'figures/JASM/burnmap_alllakes.png',
    width = 6, height = 8, units = 'in', res = 600)
ggplot() +
    geom_polygon(
    data = map_data("state"),
    aes(x = long, y = lat, group = group),
    fill = "white",
    color = "black",
    size = .5,
    alpha = 0
  ) +
  # geom_tile(data = elevation_data, aes(x = x, y = y, fill = elevation)) +
  coord_sf(
    xlim = c(-125.63435,-101.14872),
    ylim = c(30.77671, 50.16259),
    expand = FALSE
  ) + #values from buffer_box
  # geom_raster(data = hil_df,
  #             aes(x = x, y = y, alpha = layer), show.legend=FALSE) +
  # scale_fill_gradientn(colors = terrain.colors(5))+
  labs(
    # title="All lakes >1 ha in the WUS region",
       # subtitle="There are 54,286 lakes total, and only 14% (n=7693) are > 10 ha in size",
       x = "Longitude", y = "Latitude")+
  geom_point(
    data = lakezones_studyregion2 %>% filter(burn_YN=="burned"),
    aes(lake_lon_decdeg, lake_lat_decdeg, color=size_class),
    size = 1.2,
    # color="black",
    # fill=NA,
    alpha = 0.5
  ) +
  scale_color_manual(
                    values=c("#022f40","#38aecc"),
                     name="Lake size:")+
  # scale_shape_manual(values=c(16,17),
  #                    name="Lake size")+
  guides(color = guide_legend(override.aes=list(size=3,alpha=1)),
         # shape = guide_legend(override.aes=list(size=3,alpha=1)),
         fill = guide_colourbar(barwidth = 12, barheight = 0.5)) +
    theme_few()+
      theme(
        axis.ticks.y=element_line(color="white"),
        axis.ticks.x=element_line(color="white"),
        axis.line =element_line(color="white"),
        axis.text.x=element_text(size=16,color="white",angle = 45, hjust = 1),
        axis.text.y=element_text(size=18,color="white"),
        axis.title.x=element_blank(),
        axis.title.y=element_text(size=18,hjust=0.5, color="white"),
        # panel.border = element_rect(color="white"),
        # panel.background= element_rect(fill="black"),
        plot.title=element_text(size=18,hjust=0.5, color="white", face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill="#000000",color="black"),
        strip.background = element_rect(fill="#000000"),
        strip.text = element_text(color="#FFFFFF"),
        legend.position="bottom",
        legend.background = element_rect(fill="black"),
        legend.text = element_text(size=14,color="white",face="bold"))+
  labs(title="Lakes with watershed burns since 1984")
  
  
dev.off()
```


#!!!!! OLD- DO NOT RUN - ARCHIVE



## Questions:

### How many trend changepoints are detected per lake?
```{r, eval=F}
#How many trend changepoints (tcps) per lake?
n_tcps <- nested_beast %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  group_by(nhdplusv2_comid) %>%
  summarize(number_tcp=length(unique(tcp_Date)))

n_tcps%>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, number_tcp, .desc= TRUE), y=number_tcp))+
  geom_bar(stat="identity",  color="black", width=0.5)+
  labs(y="n of changepoints detected",
       x="COMID")+
  scale_y_continuous(breaks=seq(0,8,2))
```

### Do any of the trend changepoint confidence intervals span the year of the fire?

```{r, eval=F}

fire_trend_changes <- nested_beast %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  left_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = decimal_date(ymd(sprintf(
    "%d-07-01", as.numeric(as.character(yearBurn))
  )))) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
  # mutate(
  #   fire_cp = case_when(
  #     tcp_CI_low <= yearBurn & tcp_CI_high >= yearBurn ~ 'fire change',
  #     TRUE ~ "change not associated with fire"
  #   )
  # )

  # mutate(
  #   fire_cp = case_when(
  #     tcp_CI_low <= yearBurn &
  #       tcp_CI_high >= yearBurn &
  #         tcp_Date >= yearBurn &
  #           abs(yearBurn-tcp_Date)<= 5~ 'fire change',
  #     TRUE ~ "change not associated with fire"
  #   )
  # )



#FINAL
  # mutate(yearBurn = decimal_date(yearBurn)) %>%
  distinct(nhdplusv2_comid, .keep_all=TRUE) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
    mutate(
    fire_cp = case_when(
      # tcp_CI_low <= yearBurn & tcp_CI_high >= yearBurn & #Make sure tcp CI surround yearBurn
      tcp_CI_high - yearBurn <= 5 &
        #Make sure the upper bound of the tcp is within 5 years of the burn
        tcp_Date >= yearBurn - 1 &
        #tcp_Date can be up to 1 year before yearBurn
        abs(yearBurn - tcp_Date) <= 5 ~ 'fire change',
      #BUT no more than 5 years PAST yearBurn
      TRUE ~ "change not associated with fire"
    )
  )

```

```{r, eval=F}
fire_trend_changes %>%
  filter(fire_cp=="fire change") %>%
  ungroup()%>%
  add_count(cpPR>0.5) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), y=cpPR))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity",  color="black", width=0.75)+
  geom_text(aes(label=round(cpPR,2)), vjust=-1  , hjust=-0.2, size=3, angle=45) +
  labs(y="Trend changepoint occurance probability",
       x="COMID")
counts0 <- fire_trend_changes %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  group_by(`cpPR > 0.5`) %>%
  summarize(n = length(unique(nhdplusv2_comid)))

```

Yes! For `r sum(counts0$n)` lakes, the confidence intervals on the trend changepoint encompass the year of the watershed burn. For `r counts0%>%pluck(2,2)` of those lakes, the probability is quite high (>0.5). So approximately `r round(sum(counts0$n)/length(unique(colorSevereBurn_trim$nhdplusv2_comid)),2)*100`% of the lakes show a color change in response to fire. Here's a distribution of the changepoint probabilities: 

```{r, eval=F}
fire_trend_changes %>%
  filter(fire_cp=="fire change")%>%
  ggplot(aes(x=cpPR)) + 
  geom_histogram(colour="black", fill="white")+
  cowplot::theme_half_open()+
  labs(x="Changepoint probability")
```

Let's look at those lakes!

The following plots show all the lakes where the confidence intervals on one of the trend changepoints encompasses the year of the watershed burn. The black line with grey shading shows the predicted dWL with 95% CI around the trend. The red line show the time that >90% of the watershed burned. The dashed vertical line shows the date of the actual changepoint while the pink shading shows the confidence intervals around the trend changepoint. (*Note: in the next plot some of the panels come up blank when I knit this doc, but I can assure you there are actual data associated with those sites.  Just some weird ggplot issue*)

```{r, eval=F}
#Plot lakes with changepoint around fire
firetrendlakes<-fire_trend_changes %>%
           filter(fire_cp=="fire change")
# gg_title = str_wrap("All the lakes where the confidence intervals on one of the trend changepoints encompasses the year of the watershed burn")
# gg_subtitle = str_wrap("The black line with grey shading shows the predicted dWL with 95% CI around the trend. The red line show the time that >90% of the watershed
#                        burned. The dashed vertical line shows the date of the actual changepoint while the pink shading shows the confidence intervals around the trend changepoint. ")

nested_beast %>%
  unnest(c(pred_tcps)) %>%
  filter(nhdplusv2_comid %in% firetrendlakes$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  inner_join(., MTBS_severe %>%
               select(nhdplusv2_comid, yearBurn),
             by = "nhdplusv2_comid") %>%
  left_join(.,
            firetrendlakes %>% ungroup() %>% select(nhdplusv2_comid, cpPR),
            by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  ggplot() +
    facet_wrap( ~ fct_reorder(nhdplusv2_comid, cpPR, .desc = TRUE), scales =
                "free_y") +
  #Add confidence intervals around changepoint
  geom_rect(
    data = nested_beast %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% firetrendlakes$tcp_CI_low),
    aes(
      xmin = tcp_CI_low,
      xmax = tcp_CI_high,
      ymin = -Inf,
      ymax = Inf
    ),
    color = "pink",
    fill = "pink"
  ) +
  #Add confidence intervals around the dwl trend
  geom_ribbon(aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = decimal_date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
  #Add line for predicted dwl trend
  geom_line(aes(x = decimal_date(date_dec), y = dWL_pred)) +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)),
             color = "red",
             size = 0.5) +
  #Add vertical line for exact trend changepoint
  geom_vline(
    data = nested_beast %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% firetrendlakes$tcp_CI_low),
    aes(xintercept = decimal_date(as.Date(
      as.character(tcp_Date), format = "%Y"
    ))),
    linetype = "dashed",
    size = 0.5
  ) +
  #Add the cpPR on each panel
  geom_richtext(
    data = firetrendlakes,
    aes(
      x = -Inf,
      y = Inf,
      hjust = -0.1,
      vjust = 1.5,
      label = paste0("cpPR=", round(cpPR, 1))
    ),
    stat = "unique",
    color = "black",
    fill = "#f9dcc4",
    size = 2
  ) +
  theme(strip.text.x = element_textbox(size = 10)) +
  labs(
    # title = gg_title,
    # subtitle = gg_subtitle,
    y = "Predicted dominant wavelength (nm)",
    x = "Year"
  )
# ggsave("figures/tcp_gg_1.jpg", width = 8, height = 8, units = 'in')

```
![](figures/tcp_gg_1.jpg)

The next plot is the same as above but shows the raw observed dWL data. In both cases, the sites are arranged in order from the highest changepoint probability to the lower changepoint probability. 

```{r, eval=F}
firetrendlakes<-fire_trend_changes %>%
           filter(fire_cp=="fire change")
nested_beast %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% firetrendlakes$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn),
             by="nhdplusv2_comid") %>%
  left_join(., firetrendlakes %>% ungroup()%>% select(nhdplusv2_comid, cpPR, fire_cp),
            by="nhdplusv2_comid") %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(tcps)) %>%
                  filter(tcp_CI_low %in% firetrendlakes$tcp_CI_low),
  aes(xmin = tcp_CI_low, xmax = tcp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Points for raw dWL
  geom_point(aes(x=decimal_date(date), y=dWL), color="grey50", alpha=0.5, size=0.5)+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(tcps)) %>%
                filter(tcp_CI_low %in% firetrendlakes$tcp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(tcp_Date), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(data=firetrendlakes,
                  aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("cpPR=", round(cpPR,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  facet_wrap(~fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), scales="free_y")+
  theme(strip.text.x = element_textbox(size=10))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year")
```

#### How strict should our criteria be?

If you look at some of the lakes with lower changepoint probabilities (such as `nhdplusv2_comid==22954043` and `nhdplusv2_comid==23340070`) the confidence intervals are pretty wide and the exact changepoint date is a few years behind the fire. Let's take a closer look.

```{r, eval=F}
firetrendlakes %>%
  filter(nhdplusv2_comid %in% c("22954043", "23340070")) %>%
  left_join(
    .,
    nested_beast %>%
      select(nhdplusv2_comid, data) %>%
      unnest(c(data)) %>%
      filter(nhdplusv2_comid %in% c("22954043", "23340070"))
  ) %>%
  mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
  ggplot(aes(y = dWL, x = date)) +
  geom_rect(
    aes(
      xmin = as.Date(tcp_CI_low),
      xmax = as.Date(tcp_CI_high),
      ymin = -Inf,
      ymax = Inf
    ),
    color = "pink",
    fill = "pink"
  ) +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
  #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = as.Date(tcp_Date)),
             linetype = "dashed",
             size = 0.5) +
    #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22954043", "23340070")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("22954043", "23340070")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
  #Raw data
  geom_point() +
  facet_wrap( ~ nhdplusv2_comid, nrow = 2, scales = "free_y")



```

In the first lake (`nhdplusv2_comid==22954043`), the year of the burn was 2003, and the trend changepoint date was ~2012 (CI:2001-2015). In the second lake (`nhdplusv2_comid==23340070`), the year of the burn was 2006, and the trend changepoint date was ~2014 (CI:2005-2017). It's not very convincing (to me) that this can be directly attributed to the fire, though you could make the argument that the previous disturbance history does matter. From here, the path forward would be to either

1. exclude changepoint below a certain threshold, or 
2. exclude changepoints > 5 years after a fire (or even less?). 

I am leanning more toward option 2. If we do that, how many fewer lakes do we have?

```{r, eval=F}
fire_trend_changes_strict1 <- nested_beast %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  left_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
  mutate(
    fire_cp = case_when(
      tcp_CI_low <= yearBurn &
        tcp_CI_high >= yearBurn &
          abs(yearBurn-tcp_Date)<= 5~ 'fire change',
      TRUE ~ "change not associated with fire"
    )
  )

fire_trend_changes_strict1 %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  ggplot(aes(x = fct_reorder(nhdplusv2_comid, cpPR, .desc = TRUE), y = cpPR)) +
  geom_hline(yintercept = 0.5,
             color = "pink",
             linetype = "dashed") +
  geom_bar(stat = "identity",
           color = "black",
           width = 0.75) +
  geom_text(
    aes(label = round(cpPR, 2)),
    vjust = -1  ,
    hjust = -0.2,
    size = 3,
    angle = 45
  ) +
  labs(y = "Trend changepoint occurance probability",
       x = "COMID")

counts1 <- fire_trend_changes_strict1 %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  group_by(`cpPR > 0.5`) %>%
  summarize(n = length(unique(nhdplusv2_comid)))

```

We drop down to `r sum(counts1$n)` lakes where the confidence intervals on the trend changepoint encompass the year of the watershed burn **AND** the changepoint date is after the burn date. For `r counts1%>%pluck(2,2)` of those lakes, the probability is quite high (>0.5). 

Another problem that I see is that occasionally the actual changepoint is **before** the fire, even though the confidence intervals span the year of the fire. How many lakes are we left with if we are even more stringent with our criteria? 

```{r, eval=F}
fire_trend_changes_strict2 <- nested_beast %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  left_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
  mutate(
    fire_cp = case_when(
      tcp_CI_low <= yearBurn &
        tcp_CI_high >= yearBurn &
          tcp_Date >= yearBurn ~ 'fire change',
      TRUE ~ "change not associated with fire"
    )
  )

fire_trend_changes_strict2 %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  ggplot(aes(x = fct_reorder(nhdplusv2_comid, cpPR, .desc = TRUE), y = cpPR)) +
  geom_hline(yintercept = 0.5,
             color = "pink",
             linetype = "dashed") +
  geom_bar(stat = "identity",
           color = "black",
           width = 0.75) +
  geom_text(
    aes(label = round(cpPR, 2)),
    vjust = -1  ,
    hjust = -0.2,
    size = 3,
    angle = 45
  ) +
  labs(y = "Trend changepoint occurance probability",
       x = "COMID")

counts2 <- fire_trend_changes_strict2 %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  group_by(`cpPR > 0.5`) %>%
  summarize(n = length(unique(nhdplusv2_comid)))

```

We drop down to `r sum(counts2$n)` lakes where the confidence intervals on the trend changepoint encompass the year of the watershed burn **AND** the changepoint date is after the burn date. For `r counts2%>%pluck(2,2)` of those lakes, the probability is quite high (>0.5). 

```{r, eval=F}
firetrendlakesstrict<-fire_trend_changes_strict2 %>%
           filter(fire_cp=="fire change")

nested_beast %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% firetrendlakesstrict$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn), by="nhdplusv2_comid") %>%
  left_join(., firetrendlakesstrict %>% select(nhdplusv2_comid, cpPR, fire_cp)) %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(tcps)) %>%
                  filter(tcp_CI_low %in% firetrendlakesstrict$tcp_CI_low),
  aes(xmin = tcp_CI_low, xmax = tcp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Points for raw dWL
  geom_point(aes(x=decimal_date(date), y=dWL), color="grey50", alpha=0.5, size=0.5)+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(tcps)) %>%
                filter(tcp_CI_low %in% firetrendlakesstrict$tcp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(tcp_Date), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(data=firetrendlakesstrict,
                  aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("cpPR=", round(cpPR,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  facet_wrap(~fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), scales="free_y")+
  theme(strip.text.x = element_textbox(size=10,fill = "#4b816b", box.color = "#4b816b"))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year",
       title="More strict criteria for lakes with a detected trend changepoint post-fire")
```

That might be reasonable, but then we drop sites like `nhdplusv2_comid==12394530` which had the highest changepoint occurance probability. What's the best way to code this up without dropping sites like this where the change likely is real? Then again, looking at it more closely, even before the fire it looks like there was a sharp decline in dWL. There was a jump, which the model detects, but is it possible that this is independent of fire (like severe drought, which may have brought on the prime fire conditions)? Something to think about... 

```{r, eval=F}

  firetrendlakes %>%
    filter(nhdplusv2_comid == "12394530") %>%
    left_join(
      .,
      nested_beast %>%
        select(nhdplusv2_comid, data) %>%
        unnest(c(data)) %>%
        filter(nhdplusv2_comid == "12394530")
    ) %>%
    mutate_at(vars(tcp_Date, tcp_CI_low, tcp_CI_high), date_decimal) %>%
    mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
    ggplot(aes(y = dWL, x = date)) +
    geom_rect(
      aes(
        xmin = as.Date(tcp_CI_low),
        xmax = as.Date(tcp_CI_high),
        ymin = -Inf,
        ymax = Inf
      ),
      color = "pink",
      fill = "pink"
    )+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = yearBurn),
             color = "red",
             size = 0.5) +
    #Add vertical line for exact trend changepoint
    geom_vline(aes(xintercept = as.Date(tcp_Date)),
               linetype = "dashed",
               size = 0.5) +
      #Add confidence intervals around the dwl trend
  geom_ribbon(data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("12394530")),
      aes(
    ymin = (dWL_pred_CI_low),
    ymax = (dWL_pred_CI_high),
    x = as.Date(date_dec)
  ),
  inherit.aes = FALSE,
  fill = "grey50") +
    #Add line for predicted dwl trend
  geom_line(
    data = nested_beast %>%
      select(nhdplusv2_comid, pred_tcps) %>%
      unnest(c(pred_tcps)) %>%
      filter(nhdplusv2_comid %in% c("12394530")),
    aes(x = as.Date(date_dec), y = dWL_pred)
  ) +
    #Raw data
        geom_point()+
    facet_wrap(~nhdplusv2_comid)
```

Just to summarize, here's a table showing the number of lakes with a trend changepoint after refining our criteria.

```{r, eval=F}
fire_trend_changes_strict3 <- nested_beast %>%
  select(nhdplusv2_comid, tcps) %>%
  unnest(tcps) %>%
  left_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  group_by(nhdplusv2_comid, tcp_Date) %>%
  mutate(
    fire_cp = case_when(
      tcp_CI_low <= yearBurn &
        tcp_CI_high >= yearBurn &
          tcp_Date >= yearBurn &
            abs(yearBurn-tcp_Date)<= 5~ 'fire change',
      TRUE ~ "change not associated with fire"
    )
  )

counts3 <- fire_trend_changes_strict3 %>%
  filter(fire_cp == "fire change") %>%
  ungroup() %>%
  add_count(cpPR > 0.5) %>%
  group_by(`cpPR > 0.5`) %>%
  summarize(n = length(unique(nhdplusv2_comid)))


sums <- c(sum(counts0$n),
           sum(counts1$n),
           sum(counts2$n),
          sum(counts3$n))
percLakes <- c(round(sum(counts0$n)/length(unique(colorSevereBurn_trim$nhdplusv2_comid)),2)*100,
               round(sum(counts1$n)/length(unique(colorSevereBurn_trim$nhdplusv2_comid)),2)*100,
               round(sum(counts2$n)/length(unique(colorSevereBurn_trim$nhdplusv2_comid)),2)*100,
               round(sum(counts3$n)/length(unique(colorSevereBurn_trim$nhdplusv2_comid)),2)*100)
criteria <-c("(1) tcp CIs encompass year of burn ",
             "(2) same as 1, but tcp_Date also within 5 years of burn",
             "(3) same as 1, but tcp_Date >= yearBurn",
             "(4) all criteria set by 1-3")
table1<-data.frame(criteria,sums,percLakes) 
names(table1)<-c("Criteria",
                 "Number of lakes that fit criteria",
                 "Percentage of total lakes")
table1%>%knitr::kable() 
```

In case 4, the **MOST** strict criteria, here are the lakes we are left with:

```{r, eval=F}
firetrendlakesstrict<-fire_trend_changes_strict3 %>%
           filter(fire_cp=="fire change")

  
nested_beast %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% firetrendlakesstrict$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_severe %>%
              select(nhdplusv2_comid, yearBurn), by="nhdplusv2_comid") %>%
  left_join(., firetrendlakesstrict %>% select(nhdplusv2_comid, cpPR, fire_cp)) %>%
  left_join(fui.lookup) %>%
  left_join(fui.colors) %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(tcps)) %>%
                  filter(tcp_CI_low %in% firetrendlakesstrict$tcp_CI_low),
  aes(xmin = tcp_CI_low, xmax = tcp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Points for raw dWL
  geom_point(aes(x=decimal_date(date), y=dWL,color=color), alpha=0.8, size=1)+
  scale_color_identity() +
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(tcps)) %>%
                filter(tcp_CI_low %in% firetrendlakesstrict$tcp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(tcp_Date), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(data=firetrendlakesstrict,
                  aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("cpPR=", round(cpPR,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  facet_wrap(~fct_reorder(nhdplusv2_comid, cpPR, .desc= TRUE), scales="free_y")+
  theme(strip.text.x = element_textbox(size=10,fill = "grey40", box.color = "#000000"))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year",
       title="MOST strict criteria for lakes with a detected trend changepoint post-fire")+
  cowplot::panel_border() +
  cowplot::background_grid()
```

```{r,  fig.width=3,fig.height=2}
ggplot(firetrendlakesstrict, aes(x=cpPR)) + 
 geom_histogram(colour="black", fill="white")+
  cowplot::theme_half_open()+
  labs(x="Changepoint probability")
```




### Do any of the seasonal changepoint confidence intervals span the year of the fire?

Trying this again with the revised criteria. 

```{r, echo=TRUE,  out.width = '50%', out.height='50%'}

fire_seasonal_changes <- nested_beast %>%
  select(nhdplusv2_comid, scps) %>%
  unnest(scps) %>%
  left_join(., MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.numeric(as.character(yearBurn))) %>%
  group_by(nhdplusv2_comid, scp_Date) %>%
    mutate(
    fire_scp = case_when(
      # tcp_CI_low <= yearBurn & tcp_CI_high >= yearBurn & #Make sure tcp CI surround yearBurn
      scp_CI_high - yearBurn <= 5 &
        #Make sure the upper bound of the tcp is within 5 years of the burn
        scp_Date >= yearBurn - 1 &
        #tcp_Date can be up to 1 year before yearBurn
        abs(yearBurn - scp_Date) <= 5 ~ 'fire change',
      #BUT no more than 5 years PAST yearBurn
      TRUE ~ "change not associated with fire"
    )
  )
```

```{r, echo=TRUE,  out.width = '50%', out.height='50%'}
#How many lakes have a trend changepoint around the fire?
fire_seasonal_changes %>%
  filter(fire_scp=="fire change") %>%
  group_by(nhdplusv2_comid) %>%
  mutate(changepoint_number = row_number()) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)),
         changepoint_number=as.factor(as.numeric(changepoint_number)))%>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  # fct_reorder(nhdplusv2_comid, cpPR, max)
  ggplot(aes(x=fct_reorder(nhdplusv2_comid, scpPr, .desc= TRUE), y=scpPr, fill=changepoint_number))+
  geom_hline(yintercept=0.5, color="pink", linetype="dashed")+
  geom_bar(stat="identity", position="dodge", color="black")+
  # geom_text(aes(label=round(scpPr,2)), vjust=-1, size=3) +
  labs(y="Seasonal changepoint occurance probability",
       x="COMID")+
      scale_fill_manual(values=c("grey20","grey40","grey70","grey90"))

counts<-fire_seasonal_changes %>%
  filter(fire_scp=="fire change") %>% 
  ungroup()%>%
  add_count(scpPr>0.5) %>%
  group_by(`scpPr > 0.5`)%>%
  summarize(n=length(unique(nhdplusv2_comid)))

```

For `r sum(counts$n)` lakes, the confidence intervals on the trend changepoint encompass the year of the watershed burn.

Is it evident in the raw data?

```{r, fig.width=8,fig.height=8}
fireseasonallakes_over5<-fire_seasonal_changes %>%
           filter(fire_scp=="fire change")

nested_beast %>%
  unnest(c(data)) %>%
  filter(nhdplusv2_comid %in% fireseasonallakes_over5$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by="nhdplusv2_comid") %>%
  left_join(., fireseasonallakes_over5 %>% select(nhdplusv2_comid, scpPr, fire_scp)) %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(scps)) %>%
                  filter(scp_CI_low %in% fireseasonallakes_over5$scp_CI_low),
  aes(xmin = scp_CI_low, xmax = scp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Points for raw dWL
  geom_point(aes(x=decimal_date(date), y=dWL), color="grey50", alpha=0.5, size=0.5)+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(scps)) %>%
                filter(scp_CI_low %in% fireseasonallakes_over5$scp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(scp_Date), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(data=fireseasonallakes_over5,
                  aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("scpPR=", round(scpPr,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  facet_wrap(~fct_reorder(nhdplusv2_comid, scpPr, .desc= TRUE), scales="free_y")+
  theme(strip.text.x = element_textbox(size=10))+
  labs(y="Observed dominant wavelength (nm)",
       x="Year")
```

Not really... Let's look at the decomposed seasonality component from the model. 

```{r}
# testrrr<-  fire_seasonal_changes %>%
#   filter(nhdplusv2_comid %in% fireseasonallakes_over5$nhdplusv2_comid) %>%
#     left_join(
#       .,
#       nested_beast %>%
#         select(nhdplusv2_comid, pred_scps) %>%
#         unnest(c(pred_scps)) %>%
#         filter(nhdplusv2_comid %in% fireseasonallakes_over5$nhdplusv2_comid)
#     ) %>%
#   rename(dWL=dWL_season) %>%
#     left_join(fui.lookup) %>%
#   left_join(fui.colors) %>%
#     mutate_at(vars(scp_Date, scp_CI_low, scp_CI_high), date_decimal) %>%
#     mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) 
# names(testrrr)
# 
#   fire_seasonal_changes %>%
#   filter(nhdplusv2_comid %in% fireseasonallakes_over5$nhdplusv2_comid) %>%
#     left_join(
#       .,
#       nested_beast %>%
#         select(nhdplusv2_comid, pred_scps) %>%
#         unnest(c(pred_scps)) %>%
#         filter(nhdplusv2_comid %in% fireseasonallakes_over5$nhdplusv2_comid)
#     ) %>%
#   rename(dWL=dWL_season) %>%
#     left_join(fui.lookup) %>%
#   left_join(fui.colors) %>%
#     mutate_at(vars(scp_Date, scp_CI_low, scp_CI_high), date_decimal) %>%
#     mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y")) %>%
#     ggplot(aes(y = dWL, x = date_dec)) +
#     geom_rect(
#       aes(
#         xmin = as.Date(scp_CI_low),
#         xmax = as.Date(scp_CI_high),
#         ymin = -Inf,
#         ymax = Inf
#       ),
#       color = "pink",
#       fill = "pink"
#     )+
#   #Add vertical line for year of burn
#   geom_vline(aes(xintercept = yearBurn),
#              color = "red",
#              size = 0.5) +
#     #Add vertical line for exact trend changepoint
#     geom_vline(aes(xintercept = as.Date(scp_Date)),
#                linetype = "dashed",
#                size = 0.5) +
#       #Add confidence intervals around the dwl trend
#   geom_ribbon(
#     # data = nested_beast %>%
#       # select(nhdplusv2_comid, pred_scps) %>%
#       # unnest(c(pred_tcps)) %>%
#       # filter(nhdplusv2_comid %in% c("22971746")),
#       aes(
#     ymin = (dWL_pred_CI_low),
#     ymax = (dWL_pred_CI_high),
#     x = as.Date(date_dec)
#   ),
#   inherit.aes = FALSE,
#   fill = "grey50") +
#     #Add line for predicted dwl trend
#   geom_line(
#     # data = nested_beast %>%
#       # select(nhdplusv2_comid, pred_tcps) %>%
#       # unnest(c(pred_tcps)) %>%
#       # filter(nhdplusv2_comid %in% c("22971746")),
#     aes(x = as.Date(date_dec), y = dWL)
#   ) +
#     scale_color_identity() +
#     #Raw data
#     geom_point(aes(color=color))+
#     facet_wrap(~nhdplusv2_comid, scale="free_x")


nested_beast %>%
  unnest(c(pred_scps)) %>%
  filter(nhdplusv2_comid %in% fireseasonallakes_over5$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid=as.factor(as.character(nhdplusv2_comid)))%>%
  inner_join(., MTBS_moderate %>%
              select(nhdplusv2_comid, yearBurn), by="nhdplusv2_comid") %>%
  left_join(., fireseasonallakes_over5 %>% select(nhdplusv2_comid, scpPr, fire_scp)) %>%
  mutate(yearBurn=as.Date(as.character(yearBurn), format = "%Y"))%>%
  ggplot()+
  facet_wrap(~fct_reorder(nhdplusv2_comid, scpPr, .desc= TRUE), scales="free_y")+
  #Add confidence intervals around changepoint
  geom_rect(data= nested_beast %>%
                  unnest(c(scps)) %>%
                  filter(scp_CI_low %in% fireseasonallakes_over5$scp_CI_low),
  aes(xmin = scp_CI_low, xmax = scp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Ribbon around seasonality
  geom_ribbon(aes(ymin = (amp-amp_sd), ymax = (amp+amp_sd),
                                  x = decimal_date(date_dec)), inherit.aes = FALSE, fill="grey50")+
    #Line for predicted seasonality
  geom_line(aes(x=decimal_date(date_dec), y=amp))+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(data= nested_beast %>%
               unnest(c(scps)) %>%
                filter(scp_CI_low %in% fireseasonallakes_over5$scp_CI_low),
  aes(xintercept = decimal_date(as.Date(as.character(scp_Date), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(data=fireseasonallakes_over5,
                  aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("scpPR=", round(scpPr,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  theme(strip.text.x = element_textbox(size=10))+
  labs(y="Amplitude of the seasonality",
       x="Year")
# ggsave("figures/scp_gg_1.jpg", width = 8, height = 8, units = 'in')
```

If we look at the amplitude of the seasonality, it looks like there are a handful of lakes that become more variabile after the fire. How many of those lakes are also lakes with a trend changepoint?

## Common lakes with seasonal & trend changes

```{r}

## How many lakes exist in one but not the other?
joined_lakes <- full_join(fireseasonallakes_over5,fire_trend_changes_over5, by=c("nhdplusv2_comid","yearBurn"))

common_lakes<- joined_lakes %>% drop_na()
```
There are `r length(unique(common_lakes$nhdplusv2_comid))` lakes with both a trend and seasonal changepoint.

```{r}
common_seasonal_df <- nested_beast %>%
  select(nhdplusv2_comid, pred_scps) %>%
  unnest(c(pred_scps)) %>%
  filter(nhdplusv2_comid %in% common_lakes$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  # select(nhdplusv2_comid, amp, amp_sd, date_dec) %>%
  mutate(metric = "seasonal") %>%
  select(nhdplusv2_comid,
         metric,
         date_dec,
         dWL_season,
         dWL_pred_CI_high,
         dWL_pred_CI_low) %>%
  left_join(
    .,
    nested_beast %>%
      select(nhdplusv2_comid, scps) %>%
      unnest(c(scps)) %>%
      filter(scp_CI_low %in% common_lakes$scp_CI_low)
  ) %>%
  rename(
    cpDate = scp_Date,
    cp_CI_low = scp_CI_low,
    cp_CI_high = scp_CI_high,
    Pr = scpPr,
    pred = dWL_season,
    pred_CI_low = dWL_pred_CI_low,
    pred_CI_high = dWL_pred_CI_high
  ) %>%
  inner_join(., MTBS_moderate %>%
               select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y"))

common_trend_df <- nested_beast %>%
  select(nhdplusv2_comid, pred_tcps) %>%
  unnest(c(pred_tcps)) %>%
  filter(nhdplusv2_comid %in% common_lakes$nhdplusv2_comid) %>%
  mutate(nhdplusv2_comid = as.factor(as.character(nhdplusv2_comid))) %>%
  mutate(metric = "trend") %>%
  select(nhdplusv2_comid,
         metric,
         date_dec,
         dWL_pred,
         dWL_pred_CI_high,
         dWL_pred_CI_low) %>%
  left_join(
    .,
    nested_beast %>%
      select(nhdplusv2_comid, tcps) %>%
      unnest(c(tcps)) %>%
      filter(tcp_CI_low %in% common_lakes$tcp_CI_low)
  ) %>%
  rename(
    cpDate = tcp_Date,
    cp_CI_low = tcp_CI_low,
    cp_CI_high = tcp_CI_high,
    Pr = cpPR,
    pred = dWL_pred,
    pred_CI_low = dWL_pred_CI_low,
    pred_CI_high = dWL_pred_CI_high
  ) %>%
  inner_join(., MTBS_moderate %>%
               select(nhdplusv2_comid, yearBurn), by = "nhdplusv2_comid") %>%
  mutate(yearBurn = as.Date(as.character(yearBurn), format = "%Y"))

common_lakes_timeseries <- bind_rows(common_seasonal_df,
                                     common_trend_df)


###NOTE SOMETHING IS FUCKY WITH THIS PLOT. NEED TO REDRAW AND BE MORE CAEREFUL ABOUT HOW DATA ARE JOINED ####
common_lakes_timeseries %>%
  ggplot()+
  facet_wrap(metric~nhdplusv2_comid, scales="free_y", ncol=10)+
  #Add confidence intervals around changepoint
  geom_rect(aes(xmin = cp_CI_low, xmax = cp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Ribbon around seasonality
  geom_ribbon(aes(ymin = (pred_CI_low), ymax = (pred_CI_high),
                                  x = decimal_date(date_dec)), inherit.aes = FALSE, fill="grey50")+
    #Line for predicted seasonality
  geom_line(aes(x=decimal_date(date_dec), y=pred))+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = decimal_date(as.Date(as.character(cpDate), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("Pr=", round(Pr,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  theme(strip.text.x = element_textbox(size=10))
ggsave("figures/common_seasonal_and_trend_lakes.jpg", width = 12, height = 8, units = 'in')

```

That's all the sites, but let's look a little closer at a few lakes with particularly high probabilities of both, just to inspect what the trends.

```{r}

# New facet label names for lakes
id.labs <- c("Little Valley Reservoir, NV", "Mud Lake, MT")
names(id.labs) <- c("120053935", "22971746")


common_lakes_timeseries %>%
  filter(nhdplusv2_comid %in% c("120053935","22971746")) %>%
  ggplot()+
  facet_wrap(metric~nhdplusv2_comid, scales="free_y", ncol=2,
             labeller = labeller(nhdplusv2_comid = id.labs))+
  #Add confidence intervals around changepoint
  geom_rect(aes(xmin = cp_CI_low, xmax = cp_CI_high, ymin = -Inf, ymax = Inf),
      color = "pink", fill = "pink")+
  #Ribbon around seasonality
  geom_ribbon(aes(ymin = (pred_CI_low), ymax = (pred_CI_high),
                                  x = decimal_date(date_dec)), inherit.aes = FALSE, fill="grey50")+
    #Line for predicted seasonality
  geom_line(aes(x=decimal_date(date_dec), y=pred))+
  #Add vertical line for year of burn
  geom_vline(aes(xintercept = decimal_date(yearBurn)), 
                color = "red", size=0.5)+
  #Add vertical line for exact trend changepoint
  geom_vline(aes(xintercept = decimal_date(as.Date(as.character(cpDate), format = "%Y"))), 
                linetype="dashed", size=0.5)+
  #Add the cpPR on each panel
  geom_richtext(aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("Pr=", round(Pr,1))),
                stat = "unique", color="black", fill="#f9dcc4", size=2)+
  theme(strip.text.x = element_textbox(size=10))+
  labs(x="Year",
       y="Seasonality or DWL",
       title="Two lakes with both season and trend changepoints")
```

```{r}
# 
# # New facet label names for dose variable
# id.labs <- c("Unnamed natural lake, WA", "Lake Sutherland, CA (Reservoir)")
# names(id.labs) <- c("23062152", "20329440")
# 
# 
# common_lakes_timeseries %>%
#   filter(nhdplusv2_comid %in% c("23062152","20329440")) %>%
#   ggplot()+
#   facet_wrap(metric~nhdplusv2_comid, scales="free_y", ncol=2,
#              labeller = labeller(nhdplusv2_comid = id.labs))+
#   #Add confidence intervals around changepoint
#   geom_rect(aes(xmin = cp_CI_low, xmax = cp_CI_high, ymin = -Inf, ymax = Inf),
#       color = "pink", fill = "pink")+
#   #Ribbon around seasonality
#   geom_ribbon(aes(ymin = (pred_CI_low), ymax = (pred_CI_high),
#                                   x = decimal_date(date_dec)), inherit.aes = FALSE, fill="grey50")+
#     #Line for predicted seasonality
#   geom_line(aes(x=decimal_date(date_dec), y=pred))+
#   #Add vertical line for year of burn
#   geom_vline(aes(xintercept = decimal_date(yearBurn)), 
#                 color = "red", size=0.5)+
#   #Add vertical line for exact trend changepoint
#   geom_vline(aes(xintercept = decimal_date(as.Date(as.character(cpDate), format = "%Y"))), 
#                 linetype="dashed", size=0.5)+
#   #Add the cpPR on each panel
#   geom_richtext(aes(x = -Inf, y = Inf, hjust=-0.1, vjust=1.5,label= paste0("Pr=", round(Pr,1))),
#                 stat = "unique", color="black", fill="#f9dcc4", size=2)+
#   theme(strip.text.x = element_textbox(size=10))+
#   labs(x="Year",
#        y="Seasonality or DWL",
#        title="Another two lakes with both season and trend changepoints")
```

The unnamed lake in WA has the largest negative changepoint in the dataset. 
